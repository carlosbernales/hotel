<?php 
session_start();
require 'db_con.php';

// Add error reporting for debugging
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Check if form was submitted and save data to session
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $_SESSION['booking_form_data'] = $_POST;
}

// Clear form data from session after successful booking
if (isset($_GET['clear_form']) && $_GET['clear_form'] === 'true') {
    unset($_SESSION['booking_form_data']);
}

// Improved function to fetch room types with available rooms count
function getRooms($pdo) {
    try {
        // First check if we can directly use the available_rooms column from the rooms table
        $sql = "SELECT 
                    rt.room_type_id,
                    rt.room_type,
                    rt.price,
                    rt.capacity,
                    rt.image,
                    rt.image2,
                    rt.image3,
                    rt.rating,
                    rt.description,
                    rt.beds,
                    CASE 
                        WHEN rt.discount_valid_until >= CURDATE() THEN rt.discount_percent 
                        ELSE NULL 
                    END as discount_percent,
                    rt.discount_valid_until,
                    r.available_rooms,
                    r.total_rooms
                FROM room_types rt
                LEFT JOIN rooms r ON rt.room_type_id = r.room_type_id
                WHERE rt.status = 'active'
                ORDER BY rt.room_type";
                
        $stmt = $pdo->prepare($sql);
        $stmt->execute();
        $rooms = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // If no results or missing available_rooms, try alternative query
        if (count($rooms) === 0 || !isset($rooms[0]['available_rooms'])) {
            // Alternative query using COUNT
            $sql = "SELECT 
                    rt.*,
                    CASE 
                        WHEN rt.discount_valid_until >= CURDATE() THEN rt.discount_percent 
                        ELSE NULL 
                    END as discount_percent,
                    (SELECT COUNT(*) FROM rooms r WHERE r.room_type_id = rt.room_type_id AND r.status = 'Available') as available_rooms,
                    (SELECT COUNT(*) FROM rooms r WHERE r.room_type_id = rt.room_type_id) as total_rooms
                    FROM room_types rt
                    WHERE rt.status = 'active'
                    ORDER BY rt.room_type";
                    
            $stmt = $pdo->prepare($sql);
            $stmt->execute();
            $rooms = $stmt->fetchAll(PDO::FETCH_ASSOC);
        }
        
        // Update default image paths and fix existing image paths
        foreach ($rooms as &$room) {
            // Fix main image path
            if (empty($room['image'])) {
                $room['image'] = '../../../Admin/uploads/rooms/default.jpg';
            } else {
                // Use the path directly from database if it starts with uploads/
                if (strpos($room['image'], 'uploads/') === 0) {
                    $room['image'] = '../../../Admin/' . $room['image'];
                } else {
                    $filename = basename($room['image']);
                    $room['image'] = '../../../Admin/uploads/rooms/' . $filename;
                }
            }
            
            // Fix image2 path
            if (empty($room['image2'])) {
                $room['image2'] = '../../../Admin/uploads/rooms/default2.jpg';
            } else {
                if (strpos($room['image2'], 'uploads/') === 0) {
                    $room['image2'] = '../../../Admin/' . $room['image2'];
                } else {
                    $filename = basename($room['image2']);
                    $room['image2'] = '../../../Admin/uploads/rooms/' . $filename;
                }
            }
            
            // Fix image3 path
            if (empty($room['image3'])) {
                $room['image3'] = '../../../Admin/uploads/rooms/default3.jpg';
            } else {
                if (strpos($room['image3'], 'uploads/') === 0) {
                    $room['image3'] = '../../../Admin/' . $room['image3'];
                } else {
                    $filename = basename($room['image3']);
                    $room['image3'] = '../../../Admin/uploads/rooms/' . $filename;
                }
            }
            
            // Ensure numeric values
            $room['available_rooms'] = (int)($room['available_rooms'] ?? 0);
            $room['total_rooms'] = (int)($room['total_rooms'] ?? 0);
        }
        
        return $rooms;
    } catch(PDOException $e) {
        error_log("Error fetching rooms: " . $e->getMessage());
        return [];
    }
}

$rooms = getRooms($pdo);

// Add this function after getRooms() function
function getRoomReviews($pdo, $roomTypeId) {
    try {
        $sql = "SELECT 
                    rr.review_id,
                    rr.user_id,
                    rr.rating,
                    rr.review,
                    rr.created_at,
                    u.username  -- Add username from users table
                FROM room_reviews rr
                LEFT JOIN users u ON rr.user_id = u.user_id
                WHERE rr.room_type_id = :room_type_id
                ORDER BY rr.created_at DESC";
                
        $stmt = $pdo->prepare($sql);
        $stmt->execute(['room_type_id' => $roomTypeId]);
        
        $reviews = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // Format the reviews data
        foreach ($reviews as &$review) {
            // Format the date
            $review['formatted_date'] = date('M d, Y', strtotime($review['created_at']));
            
            // Set default username if null
            if (empty($review['username'])) {
                $review['username'] = 'Anonymous User';
            }
            
            // Ensure rating is numeric
            $review['rating'] = floatval($review['rating']);
        }
        
        return $reviews;
        
    } catch(PDOException $e) {
        error_log("Error fetching room reviews: " . $e->getMessage());
        return [];
    }
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E Akomoda - Rooms</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .container.my-5 {
            margin-top: 8rem !important;
        }
        .room-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0;
            overflow: hidden;
            position: relative;
        }
        .room-image {
            height: 250px;
            width: 100%;
            object-fit: cover;
        }
        .row {
            margin: 0 -10px;
        }
        .col-md-4 {
            padding: 0 10px;
            margin-bottom: 20px;
        }
        .availability-tag {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 5px 15px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .room-details {
            padding: 20px;
        }
        .room-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .rating {
            color: #ffc107;
            margin-bottom: 10px;
        }
        .price {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        .capacity {
            color: #28a745;
            margin-bottom: 15px;
        }
        .amenities {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .amenities i {
            color: #666;
        }
        .room-status {
            color: #666;
            font-size: 0.9rem;
            padding: 5px 15px;
            background: #f8f9fa;
            border-radius: 15px;
            display: inline-block;
        }
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-warning:hover {
            background-color: #ffb300;
            border-color: #ffb300;
            transform: translateY(-1px);
        }
        
        .btn-warning:disabled {
            background-color: #ffd54f;
            border-color: #ffd54f;
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn i {
            margin-right: 5px;
        }

        /* Modal styles */
        .modal-body {
            padding: 2rem;
        }
        
        .modal-body img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        
        .details-section, .amenities-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .amenities-section span {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
        }
        
        .amenities-section i {
            color: #ffc107;
        }
        
        .price-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        /* Carousel styles */
        .carousel-item img {
            height: 400px;
            object-fit: cover;
        }
        
        .carousel-indicators {
            margin-bottom: 0;
        }
        
        .carousel-indicators button {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 5px;
        }
        
        .carousel-control-prev,
        .carousel-control-next {
            width: 10%;
            opacity: 0.8;
        }
        
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            padding: 20px;
        }

        /* Star Rating styles */
        .star-rating {
            font-size: 24px;
            cursor: pointer;
        }
        
        .star-rating i {
            color: #ffc107;
            margin-right: 5px;
            transition: all 0.2s ease;
        }
        
        .star-rating i:hover,
        .star-rating i.active {
            transform: scale(1.2);
        }
        
        /* Review styles */
        .review-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        
        .review-item:last-child {
            border-bottom: none;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .review-date {
            color: #666;
            font-size: 0.9rem;
        }

        .reviewer-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .reviewer-info {
            display: flex;
            flex-direction: column;
        }
        
        .review-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .review-content {
            color: #666;
            line-height: 1.5;
        }

        /* Review List Container */
        .review-list-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .review-list-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .review-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .review-list-container::-webkit-scrollbar-thumb {
            background: #ffc107;
            border-radius: 10px;
        }
        
        .review-list-container::-webkit-scrollbar-thumb:hover {
            background: #ffb300;
        }
        
        .no-reviews-message {
            text-align: center;
            color: #666;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* Add this to your existing styles */
        .nav-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        @keyframes badgePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Add these to your existing styles */
        @import 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css';

        .discount-alert {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            padding: 0.75rem 1.25rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            animation: fadeInDown 0.5s ease-in-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .fw-bold {
            font-weight: bold !important;
        }

        /* Add to your existing styles */
        .booking-confirmation-summary {
            text-align: left;
        }
        
        .booking-confirmation-summary .card {
            margin-bottom: 1rem;
            border: 1px solid rgba(0,0,0,.125);
        }
        
        .booking-confirmation-summary .card-title {
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .booking-confirmation-summary .text-muted {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .booking-confirmation-modal {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .booking-confirmation-summary hr {
            margin: 1rem 0;
        }

        /* Add to your existing styles */
        .payment-instructions {
            text-align: left;
        }
        
        .payment-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .payment-details .btn-outline-primary {
            padding: 2px 8px;
            font-size: 12px;
        }
        
        .payment-details .btn-outline-primary:hover {
            background-color: #ffc107;
            border-color: #ffc107;
            color: white;
        }
        
        .fs-5 {
            font-size: 1.25rem !important;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }

        /* Add these styles */
        @media (max-width: 768px) {
            #paymentDetailsContainer .card-body .row {
                flex-direction: column;
            }
            
            #paymentDetailsContainer .col-md-6 {
                width: 100%;
            }
            
            #qrCodeImage {
                margin-bottom: 1rem;
            }
            
            .payment-input-section {
                border-top: 1px solid #dee2e6;
                padding-top: 1rem;
                margin-top: 1rem;
            }
        }
        
        #paymentDetailsContainer .card {
            border: 1px solid rgba(0,0,0,.125);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            max-width: 800px;
            margin: 0 auto;
        }
        
        #paymentDetailsContainer .card-body {
            padding: 1.25rem;
        }
        
        #paymentDetailsContainer .row.g-3 {
            margin: -0.5rem;
        }
        
        #paymentDetailsContainer .row.g-3 > * {
            padding: 0.5rem;
        }
        
        @media (max-width: 768px) {
            #paymentDetailsContainer .row.g-3 {
                flex-direction: column;
            }
            
            #paymentDetailsContainer .col-md-4,
            #paymentDetailsContainer .col-md-8 {
                width: 100%;
            }
            
            #qrCodeImage {
                margin: 1rem auto;
                max-width: 200px;
            }
            
            .payment-input-section {
                border-top: 1px solid #dee2e6;
                padding-top: 1rem;
                margin-top: 1rem;
            }
        }
        
        .payment-proof-preview {
            max-width: 100%;
            height: auto;
            margin-top: 0.5rem;
            border-radius: 0.375rem;
            max-height: 200px;
            object-fit: contain;
        }

        /* Add or update these styles in your <style> section */
        .payment-info-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-right: 1.5rem;
            border-right: 1px solid #dee2e6;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .account-details {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 0 0.5rem; /* Add consistent margin */
        }

        .account-details .row {
            margin: 0 -0.5rem; /* Negative margin to offset container margin */
        }

        .account-details .col-md-6 {
            display: flex;
            flex-direction: column;
            padding: 0 0.5rem; /* Add padding to columns */
        }

        .qr-section {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Update the QR code related styles */
        .qr-code-wrapper {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .qr-code-image {
            width: 100%;
            height: auto; /* Changed from 100% to auto */
            max-height: none; /* Remove max-height restriction */
            object-fit: contain;
            display: none;
        }

        .verification-form {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 0 0.5rem; /* Add consistent margin */
        }

        @media (max-width: 768px) {
            .account-details .row {
                flex-direction: column;
            }
            
            .qr-section {
                margin-top: 2rem;
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            .qr-code-wrapper {
                max-width: 280px; /* Slightly smaller on mobile */
                margin: 1rem auto;
            }
            
            .info-item {
                margin-bottom: 1rem;
            }
        }

        /* Update/add these styles */
        #paymentDetailsContainer .card {
            border: 1px solid rgba(0,0,0,.125);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        #paymentDetailsContainer .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0,0,0,.125);
            padding: 0.75rem 1.25rem;
        }

        #paymentDetailsContainer .card-body {
            padding: 0;
        }

        #paymentDetailsContainer .border-end {
            border-right: 1px solid #dee2e6;
        }

        #paymentDetailsContainer .form-control {
            border: 1px solid #ced4da;
        }

        #paymentDetailsContainer .form-control:focus {
            border-color: #ffc107;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }

        #paymentDetailsContainer .btn-outline-primary {
            border-color: #ffc107;
            color: #ffc107;
        }

        #paymentDetailsContainer .btn-outline-primary:hover {
            background-color: #ffc107;
            border-color: #ffc107;
            color: white;
        }

        .payment-proof-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            #paymentDetailsContainer .border-end {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
                margin-bottom: 1.5rem;
            }
        }

        /* Add these styles for payment verification fields */
        #paymentDetailsContainer .form-control-lg {
            height: calc(1.5em + 1rem + 2px);
            padding: .75rem 1rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: .5rem;
        }

        #paymentDetailsContainer .form-label {
            font-weight: 500;
            margin-bottom: .5rem;
        }

        #paymentDetailsContainer .form-text {
            margin-top: .5rem;
            font-size: 0.875rem;
        }

        #paymentDetailsContainer .payment-verification-section {
            height: 100%;
        }

        #paymentDetailsContainer .payment-verification-section .p-3 {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #paymentDetailsContainer .payment-verification-section .form-control {
            width: 100%;
            max-width: none;
        }

        #paymentProofPreview {
            margin-top: auto;
        }

        @media (max-width: 768px) {
            #paymentDetailsContainer .form-control-lg {
                height: calc(1.5em + .75rem + 2px);
                padding: .5rem .75rem;
            }
        }

        /* Add styles for better container alignment */
        #paymentDetailsContainer {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* Update the row layout */
        #paymentDetailsContainer .card .row {
            margin: 0;
            width: 100%;
        }

        /* Update column padding */
        #paymentDetailsContainer .col-md-6 {
            padding: 0;
        }

        /* Ensure proper spacing in mobile view */
        @media (max-width: 768px) {
            #paymentDetailsContainer .card {
                max-width: 100%;
                margin: 0;
            }
            
            #paymentDetailsContainer .col-md-6 {
                padding: 0;
            }
        }

        /* Add styles for required fields */
        .form-label .text-danger {
            font-weight: bold;
            margin-left: 2px;
        }

        #paymentDetailsContainer .form-control:invalid {
            border-color: #dc3545;
        }

        #paymentDetailsContainer .form-control:invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        #paymentDetailsContainer .form-text.text-muted {
            font-size: 0.875rem;
            color: #6c757d !important;
        }

        /* Add validation styles */
        #paymentDetailsContainer .form-control:required:valid {
            border-color: #28a745;
        }

        #paymentDetailsContainer .form-control:required:valid {
            border-color: #28a745;
        }

        /* Add these styles to your existing <style> section */
        .payment-proof-preview-modal {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }

        /* Add to your existing styles */
        .payment-proof-modal {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .payment-proof-preview-modal .swal2-popup {
            padding: 1rem;
        }

        .payment-proof-preview-modal .swal2-close:focus {
            box-shadow: none;
        }

        .btn-outline-primary {
            color: #ffc107;
            border-color: #ffc107;
        }

        .btn-outline-primary:hover {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #fff;
        }

        .payment-proof-preview-modal .swal2-title {
            color: #333;
            font-size: 1.25rem;
            padding: 1rem;
        }

        /* Add to your existing styles */
        .form-control.is-valid {
            border-color: #28a745;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='%23dc3545' viewBox='-2 -2 7 7'%3e%3cpath stroke='%23dc3545' d='M0 0l3 3m0-3L0 3'/%3e%3ccircle r='.5'/%3e%3ccircle cx='3' r='.5'/%3e%3ccircle cy='3' r='.5'/%3e%3ccircle cx='3' cy='3' r='.5'/%3e%3c/svg%3E");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        /* Update the fully booked overlay styles */
        .fully-booked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);  /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        .fully-booked-text {
            background-color: #dc3545;  /* Red background */
            color: white;
            padding: 10px 30px;
            font-size: 24px;
            font-weight: bold;
            transform: rotate(-15deg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        /* Style for disabled button */
        .btn.btn-warning:disabled {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            opacity: 0.65;
            cursor: not-allowed;
        }

        /* Available rooms display */
        .available-rooms {
            margin: 8px 0;
            font-weight: 500;
        }

        .text-success {
            color: #28a745 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        /* Add this CSS to your style section */
        .booking-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ffc107;
            color: #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .booking-list-icon.has-items {
            color: #ffc107;
        }
        
        @keyframes badgePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Discount animation */
        @keyframes discountPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: rgba(40, 167, 69, 0.1); }
            100% { transform: scale(1); }
        }
        
        .animate-discount {
            animation: discountPulse 1s ease-in-out;
            border-radius: 5px;
            padding: 5px;
            font-weight: bold;
        }
        
        .text-success {
            color: #28a745 !important;
        }

        /* Add this to your existing CSS */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Add these styles if not already present */
        .booking-confirmation-summary {
            text-align: left;
        }

        .booking-confirmation-summary .card {
            margin-bottom: 1rem;
            border: 1px solid rgba(0,0,0,.125);
        }

        .booking-confirmation-summary .card-title {
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .booking-confirmation-summary .text-muted {
            color: #6c757d;
            font-size: 0.875rem;
        }

        .booking-confirmation-summary p {
            margin-bottom: 0.5rem;
        }

        .text-success {
            color: #28a745 !important;
        }
    </style>
</head>
<body>

<?php include('nav.php'); ?>

    <div class="container my-5 pt-4">
        <div class="row">
            <?php foreach($rooms as $room): ?>
                <div class="col-md-4">
                    <div class="room-card" id="room_<?php echo $room['room_type_id']; ?>">
                        <div class="position-relative">
                            <?php
                            $imagePath = '';
                            if (!empty($room['image'])) {
                                // If image path already contains 'uploads/', use it directly
                                if (strpos($room['image'], 'uploads/') !== false) {
                                    $imagePath = '../../../Admin/' . $room['image'];
                                } else {
                                    // Otherwise, construct the path using basename
                                    $imagePath = '../../../Admin/uploads/rooms/' . basename($room['image']);
                                }
                            } else {
                                // Default image path
                                $imagePath = '../../../Admin/uploads/rooms/default.jpg';
                            }
                            ?>
                            <img src="<?php echo htmlspecialchars($imagePath); ?>" 
                                 class="room-image" 
                                 alt="<?php echo htmlspecialchars($room['room_type']); ?>"
                                 onerror="this.src='../../../Admin/uploads/rooms/default.jpg'">
                            
                            <?php if ($room['available_rooms'] <= 0): ?>
                            <div class="fully-booked-overlay">
                                <span class="fully-booked-text">FULLY BOOKED</span>
                            </div>
                            <?php endif; ?>
                        </div>

                        <div class="room-details">
                            <h5 class="room-title"><?php echo htmlspecialchars($room['room_type']); ?></h5>
                            
                            <div class="rating">
                                <?php
                                $rating = $room['rating'] ?? 0;
                                for($i = 1; $i <= 5; $i++) {
                                    if($i <= $rating) {
                                        echo '<i class="fas fa-star"></i>';
                                    } elseif($i - 0.5 <= $rating) {
                                        echo '<i class="fas fa-star-half-alt"></i>';
                                    } else {
                                        echo '<i class="far fa-star"></i>';
                                    }
                                }
                                ?>
                                <span class="text-muted">(<?php echo number_format($rating, 1); ?>)</span>
                            </div>

                            <div class="price">â‚±<?php echo number_format($room['price'], 2); ?> per night</div>
                            
                            <!-- Available rooms display -->
                            <div class="available-rooms <?php echo $room['available_rooms'] > 0 ? 'text-success' : 'text-danger'; ?>">
                                <i class="fas fa-door-open"></i> 
                                <?php if ($room['available_rooms'] > 0): ?>
                                    <?php echo $room['available_rooms']; ?> room<?php echo $room['available_rooms'] != 1 ? 's' : ''; ?> available
                                <?php else: ?>
                                    No rooms available
                                <?php endif; ?>
                            </div>

                            <div class="capacity">
                                <i class="fas fa-user-friends"></i> 
                                Max capacity: <?php echo $room['capacity']; ?> guests
                            </div>

                            <div class="amenities">
                                <i class="fas fa-snowflake" title="Air Conditioning"></i>
                                <i class="fas fa-bath" title="Private Bathroom"></i>
                                <i class="fas fa-tv" title="Flat-screen TV"></i>
                                <i class="fas fa-wifi" title="Free WiFi"></i>
                                <i class="fas fa-shower" title="Hot Shower"></i>
                            </div>

                            <div class="mt-3">
                                <button class="btn btn-warning w-100 mb-2" onclick="viewDetails(<?php echo $room['room_type_id']; ?>)">
                                    <i class="fas fa-eye"></i> VIEW DETAILS
                                </button>
                                <?php if ($room['available_rooms'] > 0): ?>
                                    <!-- Add hidden input for room quantity -->
                                    <input type="hidden" name="room_quantity" id="room_quantity_<?php echo $room['room_type_id']; ?>" 
                                           value="1" data-available="<?php echo $room['available_rooms']; ?>">
                                    <button class="btn btn-warning w-100 add-to-list-btn" data-room-id="<?php echo $room['room_type_id']; ?>">
                                        <i class="fas fa-plus"></i> ADD TO LIST
                                    </button>
                                <?php else: ?>
                                    <button class="btn btn-secondary w-100" disabled>
                                        <i class="fas fa-ban"></i> NOT AVAILABLE
                                    </button>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
    </div>

    <!-- Add this modal HTML before the closing body tag -->
    <div class="modal fade" id="roomDetailsModal" tabindex="-1" aria-labelledby="roomDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roomDetailsModalLabel">Room Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="roomImageCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators">
                                    <button type="button" data-bs-target="#roomImageCarousel" data-bs-slide-to="0" class="active"></button>
                                    <button type="button" data-bs-target="#roomImageCarousel" data-bs-slide-to="1"></button>
                                    <button type="button" data-bs-target="#roomImageCarousel" data-bs-slide-to="2"></button>
                                </div>
                                <div class="carousel-inner rounded">
                                    <div class="carousel-item active">
                                        <img id="modalRoomImage1" src="" class="d-block w-100" alt="Room Image 1">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modalRoomImage2" src="" class="d-block w-100" alt="Room Image 2">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modalRoomImage3" src="" class="d-block w-100" alt="Room Image 3">
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#roomImageCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#roomImageCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 id="modalRoomType"></h4>
                            <div class="rating mb-2">
                                <div id="modalRating"></div>
                            </div>
                            <p class="price-text mb-3" id="modalPrice"></p>
                            <div class="details-section mb-3">
                                <h6 class="fw-bold">Room Details</h6>
                                <p id="modalDescription"></p>
                                <p><i class="fas fa-user-friends"></i> <span id="modalCapacity"></span></p>
                                <p><i class="fas fa-bed"></i> <span id="modalBeds"></span></p>
                            </div>
                            <div class="amenities-section">
                                <h6 class="fw-bold">Amenities</h6>
                                <div class="d-flex flex-wrap gap-3">
                                    <span><i class="fas fa-snowflake"></i> Air Conditioning</span>
                                    <span><i class="fas fa-bath"></i> Private Bathroom</span>
                                    <span><i class="fas fa-tv"></i> Flat-screen TV</span>
                                    <span><i class="fas fa-wifi"></i> Free WiFi</span>
                                    <span><i class="fas fa-shower"></i> Hot Shower</span>
                                </div>
                            </div>
                            <!-- Reviews Section -->
                            <div class="reviews-section mt-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0">Reviews</h6>
                                    <button class="btn btn-warning btn-sm" id="writeReviewBtn">
                                        <i class="fas fa-star"></i> Write a Review
                                    </button>
                                </div>
                                <div id="reviewsList" class="review-list-container">
                                    <!-- Reviews will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Rating & Review Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ratingModalLabel">Rate & Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="ratingForm">
                        <input type="hidden" id="room_type_id" name="room_type_id">
                        <div class="mb-3">
                            <label class="form-label">Your Rating</label>
                            <div class="star-rating">
                                <i class="far fa-star" data-rating="1"></i>
                                <i class="far fa-star" data-rating="2"></i>
                                <i class="far fa-star" data-rating="3"></i>
                                <i class="far fa-star" data-rating="4"></i>
                                <i class="far fa-star" data-rating="5"></i>
                            </div>
                            <input type="hidden" name="rating" id="selected_rating" required>
                        </div>
                        <div class="mb-3">
                            <label for="review" class="form-label">Your Review</label>
                            <textarea class="form-control" id="review" name="review" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-warning">Submit Review</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this before </body> -->
    <!-- Booking List Modal -->
    <div class="modal fade" id="bookingListModal" tabindex="-1" aria-labelledby="bookingListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingListModalLabel">Your Booking List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="bookingListContent">
                        <!-- Booking list items will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning proceed-to-booking-btn">Proceed to Booking</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this before </body> -->
    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">Complete Your Booking</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bookingForm">
                        <?php if (!isset($_SESSION['user_id'])): ?>
                        <!-- Contact Information Section for Non-logged Users -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Contact Information</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="first_name" name="first_name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="last_name" name="last_name" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                        <div class="form-text">Booking confirmation will be sent here</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="phone" name="phone" 
                                               pattern="[0-9]{11}" placeholder="09XXXXXXXXX" required>
                                        <div class="form-text">Enter 11-digit phone number</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <?php endif; ?>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="check_in" class="form-label">Check-in Date</label>
                                <input type="date" class="form-control" id="check_in" name="check_in" required>
                            </div>
                            <div class="col-md-6">
                                <label for="check_out" class="form-label">Check-out Date</label>
                                <input type="date" class="form-control" id="check_out" name="check_out" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="num_guests" class="form-label">Number of Guests</label>
                            <input type="number" class="form-control" id="num_guests" name="num_guests" min="1" value="1" required>
                            </div>
                        
                        <h5 class="mt-4 mb-3">Guest Information</h5>
                        <div id="guestFieldsContainer">
                            <!-- Guest fields will be dynamically added here -->
                        </div>

                        <h5 class="mt-4 mb-3">Booking Summary</h5>
                        <div class="card mb-4">
                            <div class="card-body" id="bookingSummaryContent">
                                <!-- Booking summary will be dynamically added here -->
                            </div>
                        </div>

                        <h5 class="mt-4 mb-3">Booking Details</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="arrival_time" class="form-label">Arrival Time</label>
                                <input type="time" class="form-control" id="arrival_time" name="arrival_time" required>
                                </div>
                                <div class="col-md-4">
                                <label for="payment_option" class="form-label">Payment Option</label>
                                <select class="form-select" id="payment_option" name="payment_option" required>
                                    <option value="">Select Payment Option</option>
                                    <option value="Full Payment">Full Payment</option>
                                    <option value="Partial Payment"> Downpayment 1,500</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="payment_method" class="form-label">Payment Method</label>
                                <select class="form-select" id="payment_method" name="payment_method" required>
                                    <option value="">Select Payment Method</option>
                                    <!-- Payment methods will be loaded dynamically -->
                                </select>
                            </div>
                            
                        </div>

                        <!-- Add container for payment details -->
                        <div id="paymentDetailsContainer" class="card p-3 mb-3" style="display: none;">
                            <!-- Payment details will be loaded dynamically -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmBookingBtn">Confirm Booking</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function openRatingModal(roomId) {
            // Check if user is logged in
            <?php if (!isset($_SESSION['user_id'])): ?>
                alert('Please login to submit a review');
                return;
            <?php endif; ?>
            
            document.getElementById('room_type_id').value = roomId;
            const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
            ratingModal.show();
        }

        // Star Rating Functionality
        document.querySelectorAll('.star-rating i').forEach(star => {
            star.addEventListener('mouseover', function() {
                const rating = this.dataset.rating;
                updateStars(rating);
            });
            
            star.addEventListener('click', function() {
                const rating = this.dataset.rating;
                document.getElementById('selected_rating').value = rating;
                updateStars(rating, true);
            });
        });
        
        document.querySelector('.star-rating').addEventListener('mouseleave', function() {
            const selectedRating = document.getElementById('selected_rating').value;
            updateStars(selectedRating || 0);
        });
        
        function updateStars(rating, clicked = false) {
            document.querySelectorAll('.star-rating i').forEach(star => {
                const starRating = star.dataset.rating;
                if (starRating <= rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                    if (clicked) star.classList.add('active');
                } else {
                    star.classList.remove('fas', 'active');
                    star.classList.add('far');
                }
            });
        }
        
        // Update the review form submission handler
        document.getElementById('ratingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Always use the current room ID
            formData.set('room_type_id', window.currentRoomId);
            
            // Validate rating
            if (!formData.get('rating')) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Rating Required',
                    text: 'Please select a rating before submitting',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }
            
            // Show loading state
            Swal.fire({
                title: 'Submitting Review',
                text: 'Please wait...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Debug log
            console.log('Submitting review for room:', window.currentRoomId);
            
            fetch('submit_rating.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close rating modal
                    const ratingModal = bootstrap.Modal.getInstance(document.getElementById('ratingModal'));
                    ratingModal.hide();
                    
                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Thank You!',
                        text: 'Your review has been submitted successfully',
                        confirmButtonColor: '#ffc107'
                    }).then(() => {
                        // Refresh reviews
                        loadReviews(window.currentRoomId);
                        
                        // Reset form
                        this.reset();
                        updateStars(0);
                        
                        // Refresh the page to update room ratings
                        setTimeout(() => location.reload(), 1000);
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Failed to submit review. Please try again.',
                        confirmButtonColor: '#ffc107'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to submit review. Please try again later.',
                    confirmButtonColor: '#ffc107'
                });
            });
        });
        
        // Load Reviews
        function loadReviews(roomId) {
            console.log('Loading reviews for room:', roomId);
            
            // Show loading state
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading reviews...</p>
                </div>
            `;

            fetch(`get_reviews.php?room_type_id=${roomId}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                })
                .then(reviews => {
                    console.log('Received reviews:', reviews);
                    
                    if (!Array.isArray(reviews)) {
                        throw new Error('Invalid response format');
                    }

                    if (reviews.length === 0) {
                        reviewsList.innerHTML = `
                            <div class="text-center p-4">
                                <i class="far fa-comment-alt mb-2" style="font-size: 24px;"></i>
                                <p class="text-muted mb-0">No reviews yet. Be the first to review this room!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    reviewsList.innerHTML = reviews.map(review => `
                        <div class="review-item border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold">${escapeHtml(review.username || 'Anonymous User')}</div>
                                    <div class="rating">
                                        ${generateStars(review.rating)}
                                    </div>
                                </div>
                                <small class="text-muted">${review.formatted_date}</small>
                            </div>
                            <p class="mt-2 mb-0">${escapeHtml(review.review || '')}</p>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading reviews:', error);
                    reviewsList.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-circle"></i>
                            Error loading reviews: ${error.error || error.message || 'Unknown error'}
                            ${error.details ? `<br><small>${error.details}</small>` : ''}
                        </div>
                    `;
                });
        }
        
        function generateStars(rating) {
            let stars = '';
            for(let i = 1; i <= 5; i++) {
                if(i <= rating) {
                    stars += '<i class="fas fa-star text-warning"></i>';
                } else if(i - 0.5 <= rating) {
                    stars += '<i class="fas fa-star-half-alt text-warning"></i>';
                } else {
                    stars += '<i class="far fa-star text-warning"></i>';
                }
            }
            return stars;
        }

        function viewDetails(roomId) {
            console.log('Opening details for room:', roomId); // Debug log
            const room = <?php echo json_encode($rooms); ?>.find(r => r.room_type_id == roomId);
            
            if (room) {
                // Store current room ID for review functionality
                window.currentRoomId = roomId;
                
                // Update modal content
                document.getElementById('modalRoomType').textContent = room.room_type;
                document.getElementById('modalPrice').textContent = `â‚±${parseFloat(room.price).toLocaleString()} per night`;
                document.getElementById('modalDescription').textContent = room.description;
                document.getElementById('modalCapacity').textContent = `Max capacity: ${room.capacity} guests`;
                document.getElementById('modalBeds').textContent = room.beds;
                
                // Update carousel images
                document.getElementById('modalRoomImage1').src = room.image || 'https://srv1760-files.hstgr.io/112f0151d91cad47/files/public_html/Admin/uploads/rooms/default.jpg';
                document.getElementById('modalRoomImage2').src = room.image2 || 'https://srv1760-files.hstgr.io/112f0151d91cad47/files/public_html/Admin/uploads/rooms/default2.jpg';
                document.getElementById('modalRoomImage3').src = room.image3 || 'https://srv1760-files.hstgr.io/112f0151d91cad47/files/public_html/Admin/uploads/rooms/default3.jpg';
                
                // Update rating stars
                const rating = parseFloat(room.rating) || 0;
                let starsHtml = '';
                for(let i = 1; i <= 5; i++) {
                    if(i <= rating) {
                        starsHtml += '<i class="fas fa-star text-warning"></i>';
                    } else if(i - 0.5 <= rating) {
                        starsHtml += '<i class="fas fa-star-half-alt text-warning"></i>';
                    } else {
                        starsHtml += '<i class="far fa-star text-warning"></i>';
                    }
                }
                starsHtml += `<span class="text-muted ms-2">(${rating})</span>`;
                document.getElementById('modalRating').innerHTML = starsHtml;
                
                // Load reviews for this room
                loadReviews(roomId);
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('roomDetailsModal'));
                modal.show();
            }
        }

        // Add event listener for Write Review button
        document.getElementById('writeReviewBtn').addEventListener('click', function() {
            if (!window.currentRoomId) {
                alert('Error: Room not found');
                return;
            }
            openRatingModal(window.currentRoomId);
        });

        // Make sure the updateBadgeCount function is properly defined
        function updateBadgeCount(count) {
            // Update all booking badges (mobile and desktop)
            const badges = document.querySelectorAll('.booking-badge');
            badges.forEach(badge => {
                if (count > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = count;
                    // Add animation
                    badge.style.animation = 'none';
                    badge.offsetHeight; // Trigger reflow
                    badge.style.animation = 'badgePulse 0.3s ease-in-out';
                } else {
                    badge.style.display = 'none';
                }
            });
            
            // Also update any booking list icons
            const bookingListIcons = document.querySelectorAll('.booking-list-icon');
            bookingListIcons.forEach(icon => {
                if (count > 0) {
                    icon.classList.add('has-items');
                } else {
                    icon.classList.remove('has-items');
                }
            });
            
            console.log('Badge count updated:', count); // Add this for debugging
        }

        // Make sure to call updateBadgeCount when adding to list
        function addToList(room) {
            // Create a simple form submission instead of fetch API
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'add_to_list.php';
            form.style.display = 'none';
            
            const roomIdInput = document.createElement('input');
            roomIdInput.type = 'hidden';
            roomIdInput.name = 'room_type_id';
            roomIdInput.value = room.room_type_id;
            
            form.appendChild(roomIdInput);
            document.body.appendChild(form);
            
            // Show confirmation dialog
            Swal.fire({
                title: 'Add to List',
                text: `Add ${room.room_type} to your booking list?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, add it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading indicator
                    Swal.fire({
                        title: 'Adding to list...',
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Submit the form
                    form.submit();
                } else {
                    // Remove the form if cancelled
                    document.body.removeChild(form);
                }
            });
        }

        // Add this to handle the redirect after adding to list
        document.addEventListener('DOMContentLoaded', function() {
            // Check for success message in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('add_success');
            const message = urlParams.get('message');
            const count = urlParams.get('count');
            
            if (success === 'true') {
                                // Update badge count
                if (count) {
                    updateBadgeCount(parseInt(count));
                }

                // Show success message
                                Swal.fire({
                    title: 'Success',
                    text: message || 'Room added to booking list',
                                    icon: 'success',
                                    confirmButtonColor: '#ffc107',
                                    showConfirmButton: true,
                                    confirmButtonText: 'View Booking List',
                                    showCancelButton: true,
                    cancelButtonText: 'Continue Shopping',
                    allowOutsideClick: true,
                    didClose: () => {
                        // Remove the parameters from URL and refresh the page
                        window.location.href = window.location.pathname;
                    }
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // Show the booking list if user clicks "View Booking List"
                                        showBookingList();
                            } else {
                        // Refresh the page for any other result
                        window.location.reload();
                    }
                });
            } else if (success === 'false') {
                // Show error as a notice instead of an alert
                Swal.fire({
                    title: 'Notice',
                    text: message || 'Could not add room to your list.',
                    icon: 'info',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didClose: () => {
                        // Remove the parameters from URL and refresh the page
                        window.location.href = window.location.pathname;
                }
            });
        }
        });

        // Fix the showBookingList function to handle undefined values
        function showBookingList() {
            const bookingListModal = document.getElementById('bookingListModal');
            const bookingListContent = document.getElementById('bookingListContent');
            const proceedToBookingBtn = document.querySelector('.proceed-to-booking-btn');
            
            // Show loading indicator
            bookingListContent.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading your booking list...</p>
                </div>
            `;

            // Initialize and show the modal
            const modal = new bootstrap.Modal(bookingListModal);
            modal.show();

            // Fetch the booking list data
            fetch('get_booking_list.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.items && data.items.length > 0) {
                            // Generate HTML for items
                            let html = '';
                            data.items.forEach(item => {
                                html += `
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <div class="d-flex">
                                                <div class="me-3">
                                                    <img src="${getImagePath(item.image)}" 
                                                         alt="${item.room_type}" 
                                                         class="img-thumbnail" 
                                                         style="width: 100px; height: 80px; object-fit: cover;"
                                                         onerror="this.src='../../../Admin/uploads/rooms/default.jpg'">
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <h5 class="card-title">${item.room_type}</h5>
                                                        <button type="button" class="btn-close" onclick="removeFromList(${item.room_type_id})"></button>
                                                    </div>
                                                    <p class="card-text mb-0">Added on: ${item.added_date}</p>
                                                    <p class="card-text mb-0">â‚±${parseFloat(item.price).toLocaleString()} per night</p>
                                                    <p class="card-text mb-0"><i class="fas fa-user-friends"></i> Max capacity: ${item.capacity} guests</p>
                                                    <p class="card-text mb-0 small text-${item.available_rooms > 0 ? 'success' : 'danger'}">
                                                        <i class="fas fa-door-open"></i> ${item.available_rooms} room${item.available_rooms !== 1 ? 's' : ''} available
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });

                            // Add total amount section
                            html += `
                                <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Total Amount:</h5>
                                    <h5 class="card-title mb-0">â‚±${parseFloat(data.totalAmount).toLocaleString()} per night</h5>
                                </div>
                            </div>
                        </div>
                    `;

                            bookingListContent.innerHTML = html;
                            if (proceedToBookingBtn) proceedToBookingBtn.disabled = false;
                        } else {
                            // Show empty list message
                            bookingListContent.innerHTML = `
                                <div class="text-center py-4">
                                    <div class="mb-3">
                                        <i class="fas fa-shopping-cart text-muted" style="font-size: 3rem;"></i>
                                    </div>
                                    <h5 class="text-muted">Your booking list is empty</h5>
                                    <p class="text-muted">Add rooms to your list to start booking</p>
                                </div>
                            `;
                            if (proceedToBookingBtn) proceedToBookingBtn.disabled = true;
                        }
                    } else {
                throw new Error(data.message || 'Error loading booking list');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            bookingListContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${error.message || 'Error loading booking list. Please try again.'}
                </div>
            `;
            if (proceedToBookingBtn) proceedToBookingBtn.disabled = true;
        });
        }

        // Update the updateQuantity function to handle server-side availability errors
        function updateQuantity(roomTypeId, newQuantity) {
            // Show loading indicator
            const quantitySpan = document.querySelector(`.quantity-value[data-room-id="${roomTypeId}"]`);
            const originalText = quantitySpan ? quantitySpan.textContent : '';
            
            if (quantitySpan) {
                quantitySpan.innerHTML = '<small><i class="fas fa-spinner fa-spin"></i></small>';
            }
            
            // Ensure roomTypeId is a valid number
            if (!roomTypeId || isNaN(parseInt(roomTypeId))) {
                console.error('Invalid room ID:', roomTypeId);
                if (quantitySpan) {
                    quantitySpan.textContent = originalText;
                }
                
                Swal.fire({
                    title: 'Error',
                    text: 'Invalid room ID. Please refresh the page and try again.',
                    icon: 'error',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                return;
            }
            
            // Ensure newQuantity is a valid positive number
            if (isNaN(newQuantity) || newQuantity < 1) {
                console.error('Invalid quantity:', newQuantity);
                if (quantitySpan) {
                    quantitySpan.textContent = originalText;
                }
                
                Swal.fire({
                    title: 'Error',
                    text: 'Invalid quantity. Please try again.',
                    icon: 'error',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                return;
            }
            
            // Send request to update quantity
            const formData = new FormData();
            formData.append('room_type_id', roomTypeId);
            formData.append('quantity', newQuantity);
            formData.append('action', 'update_quantity'); // Add action parameter to clarify the request
            
            // Add debug logging
            console.log('Sending update request:', {
                room_type_id: roomTypeId,
                quantity: newQuantity,
                action: 'update_quantity'
            });
            
            fetch('update_list_quantity.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            throw new Error('Server error: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Update quantity response:', data);
                
                if (data.success) {
                    // Update the quantity display
                    if (quantitySpan) {
                        quantitySpan.textContent = data.quantity;
                    }
                    
                    // Update total amount
                    const totalAmountElement = document.querySelector('#totalAmount');
                    if (totalAmountElement && data.totalAmount) {
                        totalAmountElement.textContent = `â‚±${parseFloat(data.totalAmount).toLocaleString()} per night`;
                    }
                    
                    // Update button states
                    const decrementBtn = document.querySelector(`.decrement-btn[data-room-id="${roomTypeId}"]`);
                    
                    if (decrementBtn) {
                        decrementBtn.disabled = data.quantity <= 1;
                    }
                    
                    // If the server indicates we've reached the maximum available rooms
                    if (data.message && data.message.includes('maximum')) {
                            Swal.fire({
                                title: 'Maximum Reached',
                            text: data.message || 'You have selected all available rooms of this type.',
                                icon: 'info',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000
                            });
                    }
                } else {
                    // Restore original quantity on error
                    if (quantitySpan) {
                        quantitySpan.textContent = originalText;
                    }
                    
                    // Check for specific error messages about availability
                    if (data.message && (data.message.includes('available') || data.message.includes('maximum'))) {
                        Swal.fire({
                            title: 'Maximum Reached',
                            text: data.message || 'No more rooms available of this type.',
                            icon: 'warning',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                    } else if (data.message && data.message.includes('not in booking list')) {
                        // Handle the specific "Room not in booking list" error
                        Swal.fire({
                            title: 'Room Not Found',
                            text: 'This room is no longer in your booking list. Refreshing your list...',
                            icon: 'warning',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000
                        });
                        
                        // Refresh the booking list after a short delay
                        setTimeout(() => {
                            showBookingList();
                        }, 2000);
                    } else {
                        // Show generic error message
                    Swal.fire({
                        title: 'Update Failed',
                        text: data.message || 'Could not update room quantity.',
                        icon: 'warning',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                    }
                }
            })
            .catch(error => {
                console.error('Error updating quantity:', error);
                
                // Restore original quantity on error
                if (quantitySpan) {
                    quantitySpan.textContent = originalText;
                }
                
                // Show a more user-friendly error message
                Swal.fire({
                    title: 'Update Failed',
                    text: 'Could not update room quantity. Please try again later.',
                    icon: 'warning',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            });
        }

        // Update the incrementQuantity function to check available rooms before updating
        function incrementQuantity(roomTypeId) {
            const quantitySpan = document.querySelector(`.quantity-value[data-room-id="${roomTypeId}"]`);
            
            if (!quantitySpan) {
                console.error('Required elements not found');
                return;
            }
            
            const currentQuantity = parseInt(quantitySpan.textContent) || 1;
            
            // Find the available rooms element for this room
            // Look for the small text element within the same card as the quantity span
            const card = quantitySpan.closest('.card');
            const availabilityElement = card ? card.querySelector('p.small[class*="text-"]') : null;
            
            if (availabilityElement) {
                // Extract the number of available rooms from the text
                const availableText = availabilityElement.textContent.trim();
                const match = availableText.match(/(\d+)\s+room/);
                const availableRooms = match ? parseInt(match[1]) : 0;
                
                console.log('Available rooms check:', {
                    roomTypeId,
                    currentQuantity,
                    availableText,
                    availableRooms
                });
                
                // Only increment if there are available rooms
                if (availableRooms > 0) {
                    updateQuantity(roomTypeId, currentQuantity + 1);
                } else {
                    Swal.fire({
                        title: 'Maximum Reached',
                        text: 'No more rooms available of this type.',
                        icon: 'warning',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                }
            } else {
                // If we can't find the availability element, just try to increment
                // and let the server validate
                updateQuantity(roomTypeId, currentQuantity + 1);
            }
        }

        // Function to remove a room from the booking list
        function removeFromList(roomTypeId) {
            // Show confirmation dialog
            Swal.fire({
                title: 'Remove Room',
                text: 'Are you sure you want to remove this room from your booking list?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, remove it'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading indicator
                    Swal.fire({
                        title: 'Removing...',
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Send request to remove room
                    fetch('remove_from_list.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `room_type_id=${roomTypeId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Close loading indicator
                            Swal.close();
                            
                            // Show success message
                            Swal.fire({
                                title: 'Success!',
                                text: data.message || 'Room removed from your booking list',
                                icon: 'success',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000
                            });

                            // Update badge count
                            if (typeof data.count !== 'undefined') {
                                updateBadgeCount(data.count);
                            }

                            // Refresh the booking list modal content
                            showBookingList();
                            
                            // If no more items in list, close modal
                            if (data.count === 0) {
                                const bookingListModal = bootstrap.Modal.getInstance(document.getElementById('bookingListModal'));
                                if (bookingListModal) {
                                    bookingListModal.hide();
                                }
                            }
                        } else {
                            throw new Error(data.message || 'Failed to remove room');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: error.message || 'Could not remove room. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#ffc107'
                        });
                    });
                }
            });
        }

        // Function to update the booking summary
        function updateBookingSummary(bookingItems) {
            const summaryElement = document.getElementById('bookingSummaryContent');
            if (!summaryElement) {
                console.error('Booking summary element not found');
                return;
            }
            
            let totalAmount = 0;
            const summaryHtml = bookingItems.map(item => {
                const itemTotal = parseFloat(item.price) * parseInt(item.quantity || 1);
                totalAmount += itemTotal;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${item.room_type} (${item.quantity || 1})</span>
                        <span>â‚±${itemTotal.toLocaleString()} per night</span>
                    </div>
                `;
            }).join('');
            
            summaryElement.innerHTML = `
                ${summaryHtml}
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <strong>Total Amount per Night:</strong>
                    <strong>â‚±${totalAmount.toLocaleString()}</strong>
                </div>
            `;
            
            return totalAmount;
        }

        // Function to handle proceeding to booking
        function proceedToBooking() {
            // Show loading indicator
            Swal.fire({
                title: 'Checking your booking list',
                text: 'Please wait...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // First check if booking list is empty
            fetch('get_booking_list.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Booking list check response:', data); // Debug log
                    
                    // Close loading indicator
                    Swal.close();
                    
                    // Check if booking list is empty
                    if (!data.success || !data.items || data.items.length === 0) {
                        Swal.fire({
                            title: 'Empty Booking List',
                            text: 'You cannot proceed to booking with an empty list. Please add rooms to your booking list first.',
                            icon: 'warning',
                            confirmButtonColor: '#ffc107'
                        });
                        return;
                    }
                    
                    // Continue with booking process if list is not empty
            // Close the booking list modal
                    const bookingListModal = document.getElementById('bookingListModal');
                    if (bookingListModal) {
                        const bsModal = bootstrap.Modal.getInstance(bookingListModal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    }

            // Set minimum dates for check-in and check-out
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const checkIn = document.getElementById('check_in');
            const checkOut = document.getElementById('check_out');
            
                    if (checkIn && checkOut) {
            checkIn.min = today.toISOString().split('T')[0];
            checkOut.min = tomorrow.toISOString().split('T')[0];
            
            // Clear any previous values
            checkIn.value = '';
            checkOut.value = '';
                    }

                    // Update booking summary
                    updateBookingSummary(data.items);

                    // Show the booking form modal
                    const bookingModal = document.getElementById('bookingModal');
                    if (bookingModal) {
                        const bsModal = new bootstrap.Modal(bookingModal);
                        bsModal.show();
                        
                        // Initialize the booking form after the modal is shown
                        setTimeout(() => {
                        updateGuestFields();

                            // Set up event listener for number of guests change
                            const numGuestsInput = document.getElementById('num_guests');
                            if (numGuestsInput) {
                                numGuestsInput.addEventListener('change', updateGuestFields);
                                numGuestsInput.addEventListener('input', updateGuestFields);
                            }
                        }, 500);
                    } else {
                        console.error('Booking modal not found');
                        Swal.fire({
                            title: 'Error',
                            text: 'Could not find booking form. Please refresh the page and try again.',
                            icon: 'error',
                            confirmButtonColor: '#ffc107'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error checking booking list:', error);
                    
                    // Close loading indicator
                    Swal.close();
                    
                    Swal.fire({
                        title: 'Error',
                        text: 'Could not check booking list. Please try again later.',
                        icon: 'error',
                        confirmButtonColor: '#ffc107'
                    });
                });
        }

        // Make sure the event listener is properly attached
        document.addEventListener('DOMContentLoaded', function() {
            // Attach event listener to proceed to booking button
            const proceedToBookingBtn = document.querySelector('.proceed-to-booking-btn');
            if (proceedToBookingBtn) {
                proceedToBookingBtn.addEventListener('click', proceedToBooking);
                console.log('Proceed to booking button listener attached');
            }
            
            // Also attach the event to the button directly in case the class selector doesn't work
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => {
                if (button.textContent.trim() === 'Proceed to Booking') {
                    button.addEventListener('click', proceedToBooking);
                    console.log('Proceed to booking button found by text and listener attached');
                }
            });
            
            // Initialize booking form when modal is shown
            const bookingModal = document.getElementById('bookingModal');
            if (bookingModal) {
                bookingModal.addEventListener('shown.bs.modal', function() {
                    console.log('Booking modal shown, initializing form');
                    updateGuestFields();
                    
                    // Set up event listener for number of guests change
                    const numGuestsInput = document.getElementById('num_guests');
                    if (numGuestsInput) {
                        numGuestsInput.addEventListener('change', updateGuestFields);
                        numGuestsInput.addEventListener('input', updateGuestFields);
                    }
                });
            }
            
            // Set up event listener for confirm booking button
            const confirmBookingBtn = document.getElementById('confirmBookingBtn');
            if (confirmBookingBtn) {
                confirmBookingBtn.addEventListener('click', function() {
                    // Validate the form
                    const bookingForm = document.getElementById('bookingForm');
                    if (bookingForm.checkValidity()) {
                        // Show booking summary confirmation first
                        showBookingSummaryConfirmation();
                    } else {
                        // Trigger form validation
                        bookingForm.reportValidity();
                    }
                });
            }
        });

        // Function to handle booking form submission
        function submitBooking() {
            // Get form data
            const bookingForm = document.getElementById('bookingForm');
            const formData = new FormData(bookingForm);
            
            // Add payment proof file if it exists
            const paymentProofInput = document.getElementById('payment_proof');
            if (paymentProofInput && paymentProofInput.files.length > 0) {
                formData.append('payment_proof', paymentProofInput.files[0]);
            }
            
            // Show loading indicator
            Swal.fire({
                title: 'Processing Your Booking',
                text: 'Please wait...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Log form data for debugging
            console.log('Form data before submission:');
            for (const [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }

            // First upload the payment proof
            fetch('upload_payment_proof.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.text(); // Get response as text first
            })
            .then(text => {
                // Try to parse the response as JSON
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('Error parsing JSON response:', e);
                    console.error('Response text:', text);
                    throw new Error('Invalid JSON response from server');
                }
            })
            .then(uploadResult => {
                console.log('Upload result:', uploadResult);
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.message || 'Failed to upload payment proof');
                }

                // Now create a new FormData with all booking information
                const bookingData = new FormData();
                
                // Add all form fields
                for (const [key, value] of formData.entries()) {
                    // Skip the file input as we've already uploaded it
                    if (key !== 'payment_proof') {
                        bookingData.append(key, value);
                    }
                }
                
                // Add the uploaded file path
                bookingData.append('payment_proof_path', uploadResult.file_path);
                
                // Log booking data for debugging
                console.log('Booking data after file upload:');
                for (const [key, value] of bookingData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                // Submit the booking data
                return fetch('process_booking.php', {
                    method: 'POST',
                    body: bookingData
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.text(); // Get response as text first
            })
            .then(text => {
                // Try to parse the response as JSON
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('Error parsing JSON response:', e);
                    console.error('Response text:', text);
                    throw new Error('Invalid JSON response from server: ' + text);
                }
            })
            .then(data => {
                // Close loading indicator
                Swal.close();
                
                console.log('Booking response:', data);
                
                if (data.success) {
                    // Close all open modals first
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    });

                    Swal.fire({
                        title: 'Booking Successful!',
                        html: `
                            <div class="text-center">
                                <div class="mb-3">
                                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                                </div>
                                <h5 class="mb-3">Thank you for your booking!</h5>
                                <p class="mb-2">Your booking reference number is:</p>
                                <h4 class="text-primary mb-3">${data.booking_reference}</h4>
                                <p class="text-muted small">A confirmation email has been sent to your email address.</p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#ffc107',
                        allowOutsideClick: false
                    }).then(() => {
                        // Clear any form data
                        const bookingForm = document.getElementById('bookingForm');
                        if (bookingForm) {
                            bookingForm.reset();
                        }
                        
                        // Redirect to rooms page
                        window.location.href = 'roomss.php';
                    });
                } else {
                    // Show error message
                    Swal.fire({
                        title: 'Booking Failed',
                        text: data.message || 'There was an error processing your booking. Please try again.',
                        icon: 'error',
                        confirmButtonColor: '#ffc107'
                    });
                        }
                                })
                                .catch(error => {
                console.error('Error submitting booking:', error);
                
                // Close loading indicator
                Swal.close();
                
                // Show error message
                Swal.fire({
                    title: 'Booking Failed',
                    text: 'There was an error processing your booking. Please try again later: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#ffc107'
                });
            });
        }

        // Function to handle the confirm booking button click
        function handleConfirmBookingClick() {
            // Validate the form
            const bookingForm = document.getElementById('bookingForm');
            
            // Check if payment method is selected
            const paymentMethod = document.getElementById('payment_method');
            if (paymentMethod && paymentMethod.value === '') {
                Swal.fire({
                    title: 'Payment Method Required',
                    text: 'Please select a payment method.',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }
            
            // Check if reference number is provided
            const referenceNumber = document.getElementById('reference_number');
            if (referenceNumber && referenceNumber.value.trim() === '') {
                Swal.fire({
                    title: 'Reference Number Required',
                    text: 'Please enter the payment reference number.',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }
            
            // Check if payment proof is uploaded
            const paymentProof = document.getElementById('payment_proof');
            if (paymentProof && paymentProof.files.length === 0) {
                Swal.fire({
                    title: 'Payment Proof Required',
                    text: 'Please upload a screenshot of your payment.',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }
            
            if (bookingForm.checkValidity()) {
                // Collect all booking data for confirmation
                showBookingConfirmation();
                } else {
                // Trigger form validation
                bookingForm.reportValidity();
            }
        }

        // Function to show booking confirmation dialog
        function showBookingConfirmation() {
            // Get form data
            const formData = new FormData(document.getElementById('bookingForm'));
            const bookingData = {};
            
            // Convert FormData to object
            for (const [key, value] of formData.entries()) {
                bookingData[key] = value;
            }
            
            // Get guest information
            const numGuests = parseInt(bookingData.num_guests) || 1;
            const guestInfo = [];
            
            for (let i = 1; i <= numGuests; i++) {
                guestInfo.push({
                    firstName: bookingData[`guest_firstname_${i}`] || '',
                    lastName: bookingData[`guest_lastname_${i}`] || '',
                    guestType: bookingData[`guest_type_${i}`] || 'Regular',
                    idNumber: bookingData[`id_number_${i}`] || 'N/A'
                });
            }
            
            // Get booking summary data
            const checkIn = bookingData.check_in;
            const checkOut = bookingData.check_out;
            const nights = calculateNights(checkIn, checkOut);
            const totalAmount = parseFloat(bookingData.total_amount) || 0;
            const paymentAmount = parseFloat(bookingData.payment_amount) || totalAmount;
            const paymentOption = bookingData.payment_option;
            const paymentMethod = bookingData.payment_method;
            const referenceNumber = bookingData.reference_number;
            
            // Fetch booking items from session
            fetch('get_booking_list.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.items || data.items.length === 0) {
                        throw new Error('No booking items found');
                    }
                    
                    // Create HTML for booking confirmation
                    let roomsHtml = data.items.map(item => {
                        return `
                            <tr>
                                <td>${item.room_type}</td>
                                <td>${item.quantity || 1}</td>
                                <td>â‚±${parseFloat(item.price).toLocaleString()}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    let guestsHtml = guestInfo.map((guest, index) => {
                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${guest.firstName} ${guest.lastName}</td>
                                <td>${guest.guestType}</td>
                                <td>${guest.guestType === 'Senior Citizen' || guest.guestType === 'PWD' ? guest.idNumber : 'N/A'}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Show confirmation dialog
                    Swal.fire({
                        title: 'Confirm Your Booking',
                        html: `
                            <div class="booking-confirmation">
                                <h5 class="mb-3">Booking Details</h5>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Check-in:</strong> ${formatDate(checkIn)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Check-out:</strong> ${formatDate(checkOut)}
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Number of Nights:</strong> ${nights}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Number of Guests:</strong> ${numGuests}
                                    </div>
                                </div>
                                
                                <h5 class="mb-2">Room Details</h5>
                                <div class="table-responsive mb-3">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Room Type</th>
                                                <th>Quantity</th>
                                                <th>Price per Night</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${roomsHtml}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <h5 class="mb-2">Guest Information</h5>
                                <div class="table-responsive mb-3">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>ID Number</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${guestsHtml}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <h5 class="mb-2">Payment Details</h5>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Payment Method:</strong> ${paymentMethod}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Reference Number:</strong> ${referenceNumber}
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Payment Option:</strong> ${paymentOption}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Amount to Pay:</strong> â‚±${paymentAmount.toLocaleString()}
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <strong>Total Amount:</strong> â‚±${totalAmount.toLocaleString()}
                                    ${paymentOption === 'Partial Payment' ? 
                                        `<br><strong>Remaining Balance:</strong> â‚±${(totalAmount - paymentAmount).toLocaleString()} (to be paid at check-in)` : 
                                        ''}
                                </div>
                                
                                <p class="text-muted small">Please review all details carefully before confirming your booking.</p>

                                <div class="policy-section mt-3">
                                    <div class="policy-content mb-3" style="max-height: 200px; overflow-y: auto; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background-color: #f8f9fa;">
                                        <h6 class="text-center mb-3">CASA ESTELA BOUTIQUE HOTEL & CAFÃ‰<br>HOUSE RULES AND REGULATION</h6>
                                        <p class="small mb-3">Our warmest welcome to Casa Estela Boutique Hotel & CafÃ©!</p>
                                        <p class="small mb-2">To ensure your comfortable and pleasant stay, may we request for your cooperation in following our House Rules and Regulations:</p>
                                        <ul class="small policy-list ps-3">
                                            <li>A hotel day starts at any time after 1:00 pm during the day of arrival and ends at 11:00 A.M. of the following day. Late check-outs shall be charged at Php 200.00 per hour for a maximum of two hours extension only. Exceeding beyond 2:00 p.m. will be considered as a one-night stay and will be charged automatically.</li>
                                            <li>Breakfast will be served between 7:00 a.m. and 8:00 a.m. only.</li>
                                            <li>A refundable deposit of Php 500.00 is required upon issuance of the room key and card.</li>
                                            <li>Request for an extra pillow, duvet, bath towel or bath mat will incur an additional charge.</li>
                                            <li>Kindly deposit your room key and card at the front desk whenever you leave the hotel premises.</li>
                                            <li>Kindly turn-off lights, water supply fixtures and electrical appliances before leaving the room and when not in use.</li>
                                            <li>Smoking inside the room is strictly prohibited. If found, a penalty of P500 will be imposed.</li>
                                            <li>The management will not be held liable in any case of loss in personal property. A security box is available at the front desk where you can deposit your valuables. However, the management has the right to refuse to store money and other belongings if: they pose a threat to safety, their value exceeds the standard of the hotel or if they take up too much space.</li>
                                            <li>Damage to any hotel's equipment, fixtures or property shall result to corresponding financial charges.</li>
                                            <li>Left and unclaimed items will be kept for a period of 1 month from your departure date, unless otherwise instructed.</li>
                                            <li>PWD and Senior Citizen discounts are applicable to cash payments only.</li>
                                        </ul>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="policyCheckbox" required>
                                        <label class="form-check-label" for="policyCheckbox">I have read and agree to the house rules and regulations</label>
                                    </div>
                                </div>
                            </div>
                        `,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'Confirm Booking',
                        cancelButtonText: 'Edit Details',
                        confirmButtonColor: '#ffc107',
                        cancelButtonColor: '#6c757d',
                        width: '800px',
                        preConfirm: () => {
                            if (!document.getElementById('policyCheckbox').checked) {
                                Swal.showValidationMessage('Please read and agree to the house rules and regulations');
                                return false;
                            }
                            return true;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Process the booking
                            submitBooking();
                        }
                    });
            })
            .catch(error => {
                    console.error('Error preparing booking confirmation:', error);
                Swal.fire({
                        title: 'Error',
                        text: 'Could not prepare booking confirmation. Please try again.',
                    icon: 'error',
                    confirmButtonColor: '#ffc107'
                });
            });
        }

        // Helper function to format date
        function formatDate(dateString) {
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // Add event listener for confirm booking button
        document.addEventListener('DOMContentLoaded', function() {
            const confirmBookingBtn = document.getElementById('confirmBookingBtn');
            if (confirmBookingBtn) {
                confirmBookingBtn.addEventListener('click', handleConfirmBookingClick);
            }
        });

        // Add this helper function for copying text
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({
                    title: 'Copied!',
                    text: 'Payment number copied to clipboard',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }

        // Add event listeners for date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const checkIn = document.getElementById('check_in');
            const checkOut = document.getElementById('check_out');

            if (checkIn && checkOut) {
                checkIn.addEventListener('change', function() {
                    // Set minimum check-out date to day after check-in
                    const minCheckOut = new Date(this.value);
                    minCheckOut.setDate(minCheckOut.getDate() + 1);
                    checkOut.min = minCheckOut.toISOString().split('T')[0];
                    
                    // If check-out date is before new minimum, update it
                    if (new Date(checkOut.value) <= new Date(this.value)) {
                        checkOut.value = minCheckOut.toISOString().split('T')[0];
                    }
                    updateTotalAmount();
                });

                checkOut.addEventListener('change', updateTotalAmount);
            }
        });

        // Add these validation functions
        function validatePWDId(id) {
            // PWD ID format: RR-PPMM-BBB-NNNNNNN
            const pwdPattern = /^\d{2}-\d{2}\d{2}-\d{3}-\d{7}$/;
            return pwdPattern.test(id);
        }

        function validateSeniorId(id) {
            // Senior Citizen ID format: SCDPO-XXXXXXXX (where X is alphanumeric)
            const seniorPattern = /^SCDPO-[A-Z0-9]{8}$/;
            return seniorPattern.test(id.toUpperCase());
        }

        // Update the updateGuestFields function to include user information fields when not logged in

        function updateGuestFields() {
            const numGuests = parseInt(document.getElementById('adults').value) || 0;
            const guestFieldsContainer = document.getElementById('guestFieldsContainer');
            
            let html = '';

            // Add user information fields if not logged in
            <?php if (!isset($_SESSION['user_id'])): ?>
            html += `
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="card-title">Booking Contact Information</h6>
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle"></i> Please provide your contact information for this booking
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="user_firstname" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="user_lastname" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email Address <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" name="user_email" required
                                       pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
                                <div class="form-text">We'll send your booking confirmation here</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contact Number <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" name="user_contact" required
                                       pattern="[0-9]{11}"
                                       placeholder="e.g. 09123456789">
                                <div class="form-text">Please enter a valid 11-digit phone number</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            <?php endif; ?>

            html += `<h6 class="mb-3">Guest Information</h6>`;
            
            // Rest of your existing guest fields code...
            for (let i = 0; i < numGuests; i++) {
                html += `
                    <div class="guest-info-card card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Guest ${i + 1}</h6>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" name="guest_firstname_${i}" required>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" name="guest_lastname_${i}" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Guest Type</label>
                                    <select class="form-select" name="guest_type_${i}" onchange="handleGuestTypeChange(this, ${i})" required>
                                        <option value="regular">Regular</option>
                                        <option value="pwd">PWD</option>
                                        <option value="senior">Senior Citizen</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2 id-number-container-${i}" style="display: none;">
                                    <label class="form-label">ID Number</label>
                                    <input type="text" class="form-control" name="guest_id_number_${i}">
                                    <div class="invalid-feedback">
                                        Please enter a valid ID number in the correct format.
                                    </div>
                                </div>
                            </div>
                            <div class="row id-upload-container-${i}" style="display: none;">
                                <div class="col-12 mb-2">
                                    <label class="form-label">Upload ID</label>
                                    <input type="file" class="form-control" name="guest_id_upload_${i}" accept="image/*">
                                    <div class="form-text">Please upload a clear photo of the ID</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update the arrival time input section
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Booking Details</h6>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Arrival Time</label>
                                <input type="time" class="form-control" name="arrival_time" required>
                            </div>
                            <div class="col-md-8 mb-3">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-control" name="payment_method" onchange="handlePaymentMethodChange(this)" required>
                                            <option value="">Select Payment Method</option>
                                            <!-- Payment methods will be loaded dynamically -->
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Payment Option</label>
                                        <select class="form-control" name="payment_option" onchange="updatePaymentSummary()" required>
                                            <option value="">Select Payment Option</option>
                                            <option value="full">Full Payment</option>
                                            <option value="partial">Partial Payment</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Payment details container -->
                                <div id="paymentDetailsContainer" class="mt-3" style="display: none;">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Payment Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 border-end">
                                                    <div class="p-3">
                                                        <h6 class="fw-bold mb-3">Account Details</h6>
                                                        <div class="mb-3">
                                                            <label class="text-muted small mb-1">Account Number</label>
                                                            <div class="d-flex align-items-center bg-white p-2 rounded">
                                                                <span id="selectedAccountNumber" class="fw-bold me-2"></span>
                                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="copyAccountNumber()">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="text-muted small mb-1">Account Name</label>
                                                            <div class="bg-white p-2 rounded">
                                                                <span id="selectedAccountName" class="fw-bold"></span>
                                                            </div>
                                                        </div>
                                                        <div class="text-center mt-4">
                                                            <img id="qrCodeImage" src="" alt="QR Code" class="img-fluid rounded" style="max-width: 200px; display: none;">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="p-3">
                                                        <h6 class="fw-bold mb-3">Payment Verification</h6>
                                                        <div class="mb-4">
                                                            <label class="form-label">Reference Number <span class="text-danger">*</span></label>
                                                            <input type="text" class="form-control form-control-lg" name="payment_reference" 
                                                                   placeholder="Enter reference number" required
                                                                   oninvalid="this.setCustomValidity('Please enter the payment reference number')"
                                                                   oninput="this.setCustomValidity('')">
                                                            <div class="form-text text-muted">Enter the reference number from your payment</div>
                                                        </div>
                                                        <div class="mb-4">
                                                            <label class="form-label">Payment Proof <span class="text-danger">*</span></label>
                                                            <input type="file" class="form-control form-control-lg" name="payment_proof" 
                                                                   accept="image/*" required
                                                                   oninvalid="this.setCustomValidity('Please upload your payment proof')"
                                                                   oninput="this.setCustomValidity('')">
                                                            <div class="form-text text-muted">Upload screenshot/photo of payment</div>
                                                        </div>
                                                        <div id="paymentProofPreview" class="mt-3"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            guestFieldsContainer.innerHTML = html;

            // Add validation for contact number
            const contactInput = document.querySelector('input[name="user_contact"]');
            if (contactInput) {
                contactInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11);
                    if (this.value.length === 11) {
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                    } else {
                        this.classList.add('is-invalid');
                        this.classList.remove('is-valid');
                    }
                });
            }

            // Add validation for email
            const emailInput = document.querySelector('input[name="user_email"]');
            if (emailInput) {
                emailInput.addEventListener('input', function(e) {
                    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                    if (emailPattern.test(this.value)) {
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                    } else {
                        this.classList.add('is-invalid');
                        this.classList.remove('is-valid');
                    }
                });
            }
        }

        function handleGuestTypeChange(select, guestIndex) {
            const idNumberContainer = document.querySelector(`.id-number-container-${guestIndex}`);
            const idUploadContainer = document.querySelector(`.id-upload-container-${guestIndex}`);
            const idNumberInput = document.querySelector(`input[name="guest_id_number_${guestIndex}"]`);
            
            if (select.value === 'pwd' || select.value === 'senior') {
                idNumberContainer.style.display = 'block';
                idUploadContainer.style.display = 'block';
                
                // Add placeholder and pattern based on type
                if (select.value === 'pwd') {
                    idNumberInput.placeholder = 'Format: XX-XXXX-XXX-XXXXXXX';
                    idNumberInput.setAttribute('pattern', '\\d{2}-\\d{4}-\\d{3}-\\d{7}');
                    idNumberInput.title = 'Please enter a valid PWD ID format: RR-PPMM-BBB-NNNNNNN';
                } else {
                    idNumberInput.placeholder = 'Format: SCDPO-XXXXXXXX';
                    idNumberInput.setAttribute('pattern', 'SCDPO-[A-Z0-9]{8}');
                    idNumberInput.title = 'Please enter a valid Senior Citizen ID format: SCDPO-XXXXXXXX';
                }
                
                // Add input event listener for real-time validation
                idNumberInput.addEventListener('input', function(e) {
                    const value = e.target.value;
                    let isValid = false;
                    let errorMessage = '';
                    
                    if (select.value === 'pwd') {
                        isValid = validatePWDId(value);
                        errorMessage = 'Please enter a valid PWD ID (RR-PPMM-BBB-NNNNNNN)';
                    } else {
                        isValid = validateSeniorId(value);
                        errorMessage = 'Please enter a valid Senior Citizen ID (SCDPO-XXXXXXXX)';
                    }
                    
                    // Show validation feedback
                    if (value) {
                        if (isValid) {
                            this.classList.remove('is-invalid');
                            this.classList.add('is-valid');
                            this.setCustomValidity('');
                        } else {
                            this.classList.remove('is-valid');
                            this.classList.add('is-invalid');
                            this.setCustomValidity(errorMessage);
                        }
                    } else {
                        this.classList.remove('is-valid', 'is-invalid');
                    }
                });
                
                // Make the fields required
                idNumberInput.required = true;
                document.querySelector(`input[name="guest_id_upload_${guestIndex}"]`).required = true;
            } else {
                idNumberContainer.style.display = 'none';
                idUploadContainer.style.display = 'none';
                // Remove required attribute when not visible
                idNumberInput.required = false;
                document.querySelector(`input[name="guest_id_upload_${guestIndex}"]`).required = false;
            }
            
            // Update payment summary with discount
            updatePaymentSummary();
        }

        // Add function to calculate discounts based on guest types
        function calculateDiscount() {
            const guests = [];
            const numGuests = parseInt(document.getElementById('adults').value) || 0;
            let hasDiscount = false;
            
            for (let i = 0; i < numGuests; i++) {
                const guestType = document.querySelector(`select[name="guest_type_${i}"]`)?.value;
                if (guestType === 'pwd' || guestType === 'senior') {
                    hasDiscount = true;
                    break;
                }
            }
            
            return hasDiscount ? 0.20 : 0; // 20% discount if PWD or Senior present
        }

        // Function to calculate the number of nights between two dates
        function calculateNights(checkInDate, checkOutDate) {
            if (!checkInDate || !checkOutDate) return 0;
            
            const startDate = new Date(checkInDate);
            const endDate = new Date(checkOutDate);
            
            // Calculate the time difference in milliseconds
            const timeDiff = endDate.getTime() - startDate.getTime();
            
            // Convert time difference to days
            const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            return nights > 0 ? nights : 0;
        }

        // Add this function to calculate extra guest charges
        function calculateExtraGuestCharges(numGuests, roomCapacity) {
            const extraGuests = Math.max(0, numGuests - roomCapacity);
            return extraGuests * 1000; // â‚±1000 per extra guest
        }

        // Update the updatePaymentSummary function
        function updatePaymentSummary() {
            const paymentOption = document.querySelector('select[name="payment_option"]').value;
            const summaryContent = document.getElementById('bookingSummaryContent');
            const numGuests = parseInt(document.getElementById('adults').value) || 0;
            
            // Get all room prices and capacities from the summary
            const rooms = Array.from(summaryContent.querySelectorAll('.d-flex')).map(div => {
                const roomText = div.querySelector('span:first-child')?.textContent;
                const priceText = div.querySelector('span:last-child')?.textContent;
                
                // Find the room data from the PHP rooms array
                const roomData = <?php echo json_encode($rooms); ?>.find(r => r.room_type === roomText);
                
                if (priceText && priceText.includes('per night')) {
                    return {
                        type: roomText,
                        price: parseFloat(priceText.replace('â‚±', '').replace(',', '').replace(' per night', '')),
                        capacity: roomData ? parseInt(roomData.capacity) : 0
                    };
                }
                return null;
            }).filter(room => room !== null);

            // Calculate base amount per night (sum of all room prices)
            const baseAmountPerNight = rooms.reduce((sum, room) => sum + room.price, 0);
            const numberOfNights = calculateNights();
            
            // Calculate total room capacity
            const totalCapacity = rooms.reduce((sum, room) => sum + room.capacity, 0);
            
            // Calculate extra guest charges if applicable (flat rate of â‚±1000)
            const extraGuestCharges = numGuests > totalCapacity ? 1000 : 0;
            
            // If dates aren't selected yet, show only per night price
            if (numberOfNights === 0) {
                let paymentDetails = `
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Price per Night:</span>
                        <span>â‚±${baseAmountPerNight.toLocaleString()}</span>
                    </div>`;
                
                if (extraGuestCharges > 0) {
                    paymentDetails += `
                        <div class="alert alert-warning mb-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>Extra charge of â‚±1,000 applies for ${numGuests - totalCapacity} extra guest(s)
                    </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Extra Guest Charge (One-time):</span>
                            <span>â‚±${extraGuestCharges.toLocaleString()}</span>
                    </div>
                `;
                }
                    
                paymentDetails += `
                    <div class="alert alert-info">
                        Please select check-in and check-out dates to see total amount
                    </div>`;
                
                // Keep the original room list and add payment details
                const existingContent = summaryContent.innerHTML.split('<hr>')[0];
                summaryContent.innerHTML = existingContent + paymentDetails;
                return;
            }

            // Calculate total for all nights
            const roomTotal = baseAmountPerNight * numberOfNights;
            const originalAmount = roomTotal + extraGuestCharges; // Add flat extra guest charge
            const discountPercent = calculateDiscount();
            const discountAmount = originalAmount * discountPercent;
            const totalAmount = originalAmount - discountAmount;
            const paymentAmount = paymentOption === 'partial' ? totalAmount * 0.5 : totalAmount;
            
            // Update the summary with nights calculation and discount details
            const paymentDetails = `
                <hr>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Number of Nights:</span>
                    <span>${numberOfNights} night${numberOfNights !== 1 ? 's' : ''}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Room Rate per Night:</span>
                    <span>â‚±${baseAmountPerNight.toLocaleString()}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Room Total (${numberOfNights} nights):</span>
                    <span>â‚±${roomTotal.toLocaleString()}</span>
                </div>
                ${extraGuestCharges > 0 ? `
                    <div class="alert alert-warning mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>Extra charge applies for ${numGuests - totalCapacity} guest(s) exceeding room capacity
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Extra Guest Charge (One-time):</span>
                        <span>â‚±${extraGuestCharges.toLocaleString()}</span>
                    </div>
                ` : ''}
                <div class="d-flex justify-content-between align-items-center mb-2 fw-bold">
                    <span>Subtotal:</span>
                    <span>â‚±${originalAmount.toLocaleString()}</span>
                </div>
                ${discountPercent > 0 ? `
                    <div class="discount-alert alert alert-success mb-2 animate__animated animate__fadeIn">
                        <i class="fas fa-tags me-2"></i>20% Discount Applied for PWD/Senior Citizen
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-danger mb-2">
                        <span>Discount (20%):</span>
                        <span>-â‚±${discountAmount.toLocaleString()}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center fw-bold mb-2">
                        <span>Total After Discount:</span>
                        <span>â‚±${totalAmount.toLocaleString()}</span>
                    </div>
                ` : ''}
                <div class="d-flex justify-content-between align-items-center text-primary fw-bold">
                    <strong>${paymentOption === 'partial' ? 'Down Payment (1,500)' : 'Full Payment'}:</strong>
                    <strong>â‚±${paymentAmount.toLocaleString()}</strong>
                </div>
                ${paymentOption === 'partial' ? `
                    <div class="d-flex justify-content-between align-items-center text-muted">
                        <span>Remaining Balance:</span>
                        <span>â‚±${(totalAmount - paymentAmount).toLocaleString()}</span>
                    </div>
                ` : ''}
            `;
            
            // Keep the original room list and add payment details
            const existingContent = summaryContent.innerHTML.split('<hr>')[0];
            summaryContent.innerHTML = existingContent + paymentDetails;
        }

        // Add function to update total when dates change
        function updateTotalAmount() {
            const checkIn = new Date(document.getElementById('check_in').value);
            const checkOut = new Date(document.getElementById('check_out').value);
            
            if (checkIn && checkOut && checkOut > checkIn) {
                updatePaymentSummary();
            }
        }

        // Add this function to handle the confirm booking action
        function showBookingSummaryConfirmation() {
            const form = document.getElementById('bookingForm');
            const formData = new FormData(form);
            
            let missingFields = [];

            // Add validation for user information if not logged in
            <?php if (!isset($_SESSION['user_id'])): ?>
            if (!formData.get('user_firstname')) missingFields.push('Your First Name');
            if (!formData.get('user_lastname')) missingFields.push('Your Last Name');
            if (!formData.get('user_email')) missingFields.push('Your Email Address');
            if (!formData.get('user_contact')) missingFields.push('Your Contact Number');

            // Validate email format
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (formData.get('user_email') && !emailPattern.test(formData.get('user_email'))) {
                Swal.fire({
                    title: 'Invalid Email Format',
                    text: 'Please enter a valid email address',
                    icon: 'error',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }

            // Validate contact number format
            if (formData.get('user_contact') && formData.get('user_contact').length !== 11) {
                Swal.fire({
                    title: 'Invalid Contact Number',
                    text: 'Please enter a valid 11-digit phone number',
                    icon: 'error',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }
            <?php endif; ?>

            // Check dates
            if (!formData.get('check_in')) missingFields.push('Check-in Date');
            if (!formData.get('check_out')) missingFields.push('Check-out Date');

            // Check arrival time and payment details
            if (!formData.get('arrival_time')) missingFields.push('Arrival Time');
            if (!formData.get('payment_method')) missingFields.push('Payment Method');
            if (!formData.get('payment_option')) missingFields.push('Payment Option');

            // Check payment reference and proof
            const paymentReference = document.querySelector('input[name="payment_reference"]');
            const paymentProof = document.querySelector('input[name="payment_proof"]');
            
            if (!paymentReference.value.trim()) {
                missingFields.push('Payment Reference Number');
            }
            
            if (!paymentProof.files || paymentProof.files.length === 0) {
                missingFields.push('Payment Proof Upload');
            }

            // Check guest information
            const numGuests = parseInt(document.getElementById('adults').value);
            for (let i = 0; i < numGuests; i++) {
                const firstName = formData.get(`guest_firstname_${i}`);
                const lastName = formData.get(`guest_lastname_${i}`);
                const guestType = formData.get(`guest_type_${i}`);
                
                if (!firstName) missingFields.push(`Guest ${i + 1} First Name`);
                if (!lastName) missingFields.push(`Guest ${i + 1} Last Name`);
                if (!guestType) missingFields.push(`Guest ${i + 1} Type`);

                // Check for PWD/Senior ID requirements
                if (guestType === 'pwd' || guestType === 'senior') {
                    const idNumber = formData.get(`guest_id_number_${i}`);
                    const idUpload = formData.get(`guest_id_upload_${i}`);
                    
                    if (!idNumber) missingFields.push(`Guest ${i + 1} ID Number`);
                    if (!idUpload) missingFields.push(`Guest ${i + 1} ID Upload`);
                }
            }

            // If there are missing fields, show error message with specific styling
            if (missingFields.length > 0) {
                Swal.fire({
                    title: 'Missing Required Fields',
                    html: `
                        <div class="text-left">
                            <p class="mb-2">Please fill in the following required fields:</p>
                            <ul style="text-align: left; display: inline-block; color: #dc3545;">
                                ${missingFields.map(field => `<li><i class="fas fa-exclamation-circle"></i> ${field}</li>`).join('')}
                            </ul>
                        </div>
                    `,
                    icon: 'error',
                    confirmButtonColor: '#ffc107',
                    showClass: {
                        popup: 'animate__animated animate__fadeInDown'
                    }
                });
                return;
            }

            // Validate ID formats for PWD/Senior
            for (let i = 0; i < numGuests; i++) {
                const guestType = formData.get(`guest_type_${i}`);
                if (guestType === 'pwd' || guestType === 'senior') {
                    const idNumber = formData.get(`guest_id_number_${i}`);
                    const isValid = guestType === 'pwd' ? 
                        validatePWDId(idNumber) : 
                        validateSeniorId(idNumber);
                    
                    if (!isValid) {
                        Swal.fire({
                            title: 'Invalid ID Format',
                            text: `Please check the ID format for Guest ${i + 1}`,
                            icon: 'error',
                            confirmButtonColor: '#ffc107'
                        });
                        return;
                    }
                }
            }

            // Close the booking modal before showing summary
            const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
            bookingModal.hide();

            // If all validations pass, proceed with showing the booking summary
            let guestsHtml = '';
            for (let i = 0; i < numGuests; i++) {
                const firstName = formData.get(`guest_firstname_${i}`);
                const lastName = formData.get(`guest_lastname_${i}`);
                const guestType = formData.get(`guest_type_${i}`);
                const idNumber = formData.get(`guest_id_number_${i}`);
                
                guestsHtml += `
                    <div class="mb-2">
                        <strong>Guest ${i + 1}:</strong> ${firstName} ${lastName}
                        <br>
                        <small class="text-muted">Type: ${guestType.charAt(0).toUpperCase() + guestType.slice(1)}
                        ${idNumber ? `<br>ID Number: ${idNumber}` : ''}
                        </small>
                    </div>
                `;
            }

            // Get booking details
            const checkIn = new Date(formData.get('check_in')).toLocaleDateString();
            const checkOut = new Date(formData.get('check_out')).toLocaleDateString();
            const arrivalTime = formData.get('arrival_time');
            const paymentMethod = formData.get('payment_method');
            const paymentOption = formData.get('payment_option');

            // Get current summary content
            const summaryContent = document.getElementById('bookingSummaryContent').innerHTML;

            // Get payment proof preview URL
            const paymentProofFile = document.querySelector('input[name="payment_proof"]').files[0];
            const paymentProofUrl = paymentProofFile ? URL.createObjectURL(paymentProofFile) : '';

                Swal.fire({
                    title: 'Booking Summary',
                    html: `
                        <div class="booking-confirmation-summary">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Dates & Times</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Check-in</small>
                                            <div>${checkIn}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Check-out</small>
                                            <div>${checkOut}</div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Arrival Time</small>
                                        <div>${arrivalTime}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Guest Information</h6>
                                    ${guestsHtml}
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Payment Details</h6>
                                    <div class="mb-2">
                                        <small class="text-muted">Payment Method</small>
                                        <div>${paymentMethod.toUpperCase()}</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Payment Option</small>
                                        <div>${paymentOption === 'full' ? 'Full Payment' : ' 1,500 Down Payment'}</div>
                                    </div>
                                <div class="mb-2">
                                    <small class="text-muted">Reference Number</small>
                                    <div>${paymentReference.value}</div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Payment Proof</small>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">Uploaded proof of payment</span>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showPaymentProof('${paymentProofUrl}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                </div>
                                    <hr>
                                    ${summaryContent.split('<hr>')[1]}
                                </div>
                            </div>
                        </div>
                    `,
                    width: '600px',
                    showCancelButton: true,
                    confirmButtonText: 'Confirm & Pay',
                    confirmButtonColor: '#ffc107',
                    cancelButtonText: 'Edit Booking',
                    customClass: {
                        container: 'booking-confirmation-modal'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitBooking();
                    } else {
                        // If cancelled, show the booking modal again
                        bookingModal.show();
                    }
                });
        }

        // Add these functions back
        function handlePaymentMethodChange(select) {
            const container = document.getElementById('paymentDetailsContainer');
            const accountNumber = document.getElementById('selectedAccountNumber');
            const accountName = document.getElementById('selectedAccountName');
            const qrCode = document.getElementById('qrCodeImage');
            const paymentReference = document.querySelector('input[name="payment_reference"]');
            const paymentProof = document.querySelector('input[name="payment_proof"]');
            
            if (select.value) {
                const selectedOption = select.options[select.selectedIndex];
                accountNumber.textContent = selectedOption.dataset.number;
                accountName.textContent = selectedOption.dataset.name;
                
                if (selectedOption.dataset.qr) {
                    qrCode.src = selectedOption.dataset.qr;
                    qrCode.style.display = 'block';
                } else {
                    qrCode.style.display = 'none';
                }
                
                // Add real-time validation for payment reference
                paymentReference.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        Swal.fire({
                            title: 'Required Field',
                            text: 'Please enter the payment reference number',
                            icon: 'warning',
                            confirmButtonColor: '#ffc107',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });
                    }
                });

                // Add real-time validation for payment proof
                paymentProof.addEventListener('change', function() {
                    if (!this.files || this.files.length === 0) {
                        Swal.fire({
                            title: 'Required Field',
                            text: 'Please upload your payment proof',
                            icon: 'warning',
                            confirmButtonColor: '#ffc107',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });
                    } else {
                        handlePaymentProofUpload(this);
                    }
                });
                
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        function copyAccountNumber() {
            const accountNumber = document.getElementById('selectedAccountNumber').textContent;
            navigator.clipboard.writeText(accountNumber).then(() => {
                Swal.fire({
                    title: 'Copied!',
                    text: 'Account number copied to clipboard',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }

        function handlePaymentProofUpload(input) {
            const previewContainer = document.getElementById('paymentProofPreview');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewContainer.innerHTML = `
                        <div class="mt-3">
                            <h6 class="section-title mb-3">Preview</h6>
                            <img src="${e.target.result}" class="payment-proof-preview" alt="Payment Proof">
                        </div>
                    `;
                }
                
                reader.readAsDataURL(input.files[0]);
            } else {
                previewContainer.innerHTML = '';
            }
        }

        // Update the showBookingSummary function to include payment validation
        function showBookingSummary() {
            // Get payment-related elements
            const paymentMethod = document.querySelector('select[name="payment_method"]').value;
            const paymentOption = document.querySelector('select[name="payment_option"]').value;
            const paymentReference = document.querySelector('input[name="payment_reference"]').value;
            const paymentProof = document.querySelector('input[name="payment_proof"]').files[0];

            // Check if payment method and option are selected
            if (!paymentMethod || !paymentOption) {
                Swal.fire({
                    title: 'Missing Payment Information',
                    text: 'Please select both payment method and payment option.',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }

            // Check if payment details are filled when payment method is selected
            if (paymentMethod) {
                if (!paymentReference || !paymentProof) {
                    Swal.fire({
                        title: 'Incomplete Payment Details',
                        text: 'Please provide both payment reference number and proof of payment.',
                        icon: 'warning',
                        confirmButtonColor: '#ffc107'
                    });
                    return;
                }
            }

            // If all validations pass, proceed with the existing summary logic
            setTimeout(() => {
                bookingModal.hide();
                
                // Get guest information
                const guestFields = document.getElementById('guestFields');
                const guestInputs = guestFields.querySelectorAll('input, select');
                let isValid = true;
                
                // Validate all guest inputs
                guestInputs.forEach(input => {
                    if (input.hasAttribute('required') && !input.value) {
                        isValid = false;
                    }
                });
                
                if (!isValid) {
                    Swal.fire({
                        title: 'Missing Information',
                        text: 'Please fill in all required guest information.',
                        icon: 'warning',
                        confirmButtonColor: '#ffc107'
                    });
                    bookingModal.show();
                    return;
                }

                // Continue with existing summary display code...
                const summaryContent = document.getElementById('bookingSummary').innerHTML;
                
                Swal.fire({
                    title: 'Booking Summary',
                    html: `
                        <div class="booking-confirmation-summary">
                            <!-- Existing summary content -->
                        </div>
                    `,
                    // Rest of your existing summary code...
                });
            }, 200);
        }

        // Add real-time validation for payment fields
        function setupPaymentValidation() {
            const paymentReferenceInput = document.querySelector('input[name="payment_reference"]');
            const paymentProofInput = document.querySelector('input[name="payment_proof"]');
            const paymentMethodSelect = document.querySelector('select[name="payment_method"]');
            const paymentOptionSelect = document.querySelector('select[name="payment_option"]');

            function validatePaymentFields() {
                const isReferenceValid = paymentReferenceInput.value.trim() !== '';
                const isProofValid = paymentProofInput.files.length > 0;
                const isMethodValid = paymentMethodSelect.value !== '';
                const isOptionValid = paymentOptionSelect.value !== '';

                if (isMethodValid) {
                    paymentReferenceInput.required = true;
                    paymentProofInput.required = true;
                }

                return isReferenceValid && isProofValid && isMethodValid && isOptionValid;
            }

            // Add validation to payment method change
            const originalPaymentMethodChange = handlePaymentMethodChange;
            handlePaymentMethodChange = function(select) {
                originalPaymentMethodChange(select);
                setupPaymentValidation();
            };
        }

        // Call setup function when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupPaymentValidation();
        });

        // Add this function after your existing JavaScript code
        function showPaymentProof(imageUrl) {
            Swal.fire({
                title: 'Payment Proof',
                html: `
                    <div class="payment-proof-modal">
                        <img src="${imageUrl}" alt="Payment Proof" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                    </div>
                `,
                width: '800px',
                showCloseButton: true,
                showConfirmButton: false,
                customClass: {
                    container: 'payment-proof-preview-modal'
                }
            });
        }

        // Add this JavaScript function to handle form data
        function saveFormData() {
            const form = document.getElementById('bookingForm');
            const formData = new FormData(form);
            const data = {};
            
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Save form data to sessionStorage
            sessionStorage.setItem('bookingFormData', JSON.stringify(data));
        }

        // Add function to restore form data
        function restoreFormData() {
            // Check for data in sessionStorage first
            const storedData = sessionStorage.getItem('bookingFormData');
            if (storedData) {
                const data = JSON.parse(storedData);
                const form = document.getElementById('bookingForm');
                
                // Restore form fields
                Object.keys(data).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = data[key];
                    }
                });
                
                // Update any dependent fields or calculations
                updateTotalAmount();
                return;
            }
            
            // If no sessionStorage data, check PHP session data
            <?php if (isset($_SESSION['booking_form_data'])): ?>
            const sessionData = <?php echo json_encode($_SESSION['booking_form_data']); ?>;
            const form = document.getElementById('bookingForm');
            
            Object.keys(sessionData).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = sessionData[key];
                }
            });
            
            // Update calculations
            updateTotalAmount();
            <?php endif; ?>
        }

        // Add event listeners for form fields
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('bookingForm');
            
            // Restore form data when page loads
            restoreFormData();
            
            // Save form data when fields change
            form.addEventListener('change', saveFormData);
            
            // Save form data before page unload
            window.addEventListener('beforeunload', saveFormData);
            
            // Add offline/online handlers
            window.addEventListener('offline', function() {
                Swal.fire({
                    title: 'You are offline!',
                    text: 'Don\'t worry, your booking information has been saved.',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
            });
            
            window.addEventListener('online', function() {
                Swal.fire({
                    title: 'You\'re back online!',
                    text: 'You can continue with your booking.',
                    icon: 'success',
                    confirmButtonColor: '#ffc107'
                });
            });
        });

        // Modify your success handler to clear saved data
        function handleBookingSuccess() {
            // Clear stored form data
            sessionStorage.removeItem('bookingFormData');
            
            // Make an AJAX call to clear PHP session data
            fetch('roomss.php?clear_form=true')
                .then(() => {
                    // Redirect or show success message
                    window.location.href = 'mybookings.php';
                });
        }

        // Function to handle "Add to List" button clicks
        function setupAddToListButtons() {
            const addToListButtons = document.querySelectorAll('.add-to-list-btn');
            
            addToListButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const roomTypeId = this.getAttribute('data-room-id');
                    if (!roomTypeId) {
                        Swal.fire({
                            title: 'Error',
                            text: 'Room ID not found',
                            icon: 'error',
                            confirmButtonColor: '#ffc107'
                        });
                        return;
                    }
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('room_type_id', roomTypeId);
                    
                    // Send AJAX request
                    fetch('add_to_list.php', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Success',
                                text: data.message,
                                icon: 'success',
                                confirmButtonColor: '#ffc107',
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                // Clear form fields
                                const form = document.getElementById('bookingForm');
                                if (form) {
                                    form.reset();
                                }
                                
                                // Clear session storage
                                sessionStorage.removeItem('bookingFormData');
                                
                                // Redirect to roomss.php
                                window.location.href = 'roomss.php';
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'Failed to add room to list',
                                icon: 'error',
                                confirmButtonColor: '#ffc107'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'An unexpected error occurred',
                            icon: 'error',
                            confirmButtonColor: '#ffc107'
                        });
                    });
                });
            });
        }
        
        // Initialize when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupAddToListButtons();
        });

        // Add this to your document ready function
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize booking list badge
            fetch('get_booking_list.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.count) {
                        updateBadgeCount(data.count);
                    }
                })
                .catch(error => {
                    console.error('Error initializing booking badge:', error);
                });
            
            // Set up event listeners for Add to List buttons
            document.querySelectorAll('.add-to-list-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const roomId = this.getAttribute('data-room-id');
                    const room = <?php echo json_encode($rooms); ?>.find(r => r.room_type_id == roomId);
                    if (room) {
                        addToList(room);
                    } else {
                        console.error('Room not found:', roomId);
                    }
                });
            });
        });

        // Add these functions to handle quantity updates
        function incrementQuantity(roomTypeId) {
            const quantitySpan = document.querySelector(`.quantity-value[data-room-id="${roomTypeId}"]`);
            
            if (!quantitySpan) {
                console.error('Required elements not found');
                return;
            }
            
            const currentQuantity = parseInt(quantitySpan.textContent) || 1;
            
            // Find the available rooms element for this room
            // Look for the small text element within the same card as the quantity span
            const card = quantitySpan.closest('.card');
            const availabilityElement = card ? card.querySelector('p.small[class*="text-"]') : null;
            
            if (availabilityElement) {
                // Extract the number of available rooms from the text
                const availableText = availabilityElement.textContent.trim();
                const match = availableText.match(/(\d+)\s+room/);
                const availableRooms = match ? parseInt(match[1]) : 0;
                
                console.log('Available rooms check:', {
                    roomTypeId,
                    currentQuantity,
                    availableText,
                    availableRooms
                });
            
            // Only increment if there are available rooms
            if (availableRooms > 0) {
                updateQuantity(roomTypeId, currentQuantity + 1);
            } else {
                Swal.fire({
                        title: 'Maximum Reached',
                        text: 'No more rooms available of this type.',
                        icon: 'warning',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                });
                }
            } else {
                // If we can't find the availability element, just try to increment
                // and let the server validate
                updateQuantity(roomTypeId, currentQuantity + 1);
            }
        }

        function decrementQuantity(roomTypeId) {
            const quantitySpan = document.querySelector(`.quantity-value[data-room-id="${roomTypeId}"]`);
            
            if (!quantitySpan) {
                console.error('Quantity element not found');
                return;
            }
            
            const currentQuantity = parseInt(quantitySpan.textContent);
            
            // Only decrement if quantity is greater than 1
            if (currentQuantity > 1) {
                updateQuantity(roomTypeId, currentQuantity - 1);
            } else {
                // Ask if they want to remove the room entirely
                Swal.fire({
                    title: 'Remove Room?',
                    text: 'Do you want to remove this room from your list?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, remove it'
                }).then((result) => {
                    if (result.isConfirmed) {
                        removeFromList(roomTypeId);
                    }
                });
            }
        }

        // Function to handle guest fields visibility
        function updateGuestFields() {
            const numGuests = parseInt(document.getElementById('num_guests').value) || 1;
            const guestFieldsContainer = document.getElementById('guestFieldsContainer');
            
            if (!guestFieldsContainer) {
                console.error('Guest fields container not found');
                return;
            }
            
            console.log('Updating guest fields for', numGuests, 'guests');
            
            // Always show at least one guest field
            let html = '';
            
            for (let i = 1; i <= numGuests; i++) {
                html += `
                    <div class="guest-info-card mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Guest ${i}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="guest_firstname_${i}" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="guest_firstname_${i}" name="guest_firstname_${i}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="guest_lastname_${i}" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="guest_lastname_${i}" name="guest_lastname_${i}" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label for="guest_type_${i}" class="form-label">Guest Type</label>
                                        <select class="form-select" id="guest_type_${i}" name="guest_type_${i}" required>
                                            <option value="Regular">Regular</option>
                                            <option value="Senior Citizen">Senior Citizen</option>
                                            <option value="PWD">PWD</option>
                                            <option value="Child">Child</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            guestFieldsContainer.innerHTML = html;
            console.log('Guest fields updated:', guestFieldsContainer.innerHTML.length > 0);
        }

        // Make sure to call this function when the modal is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize booking form when modal is shown
            const bookingModal = document.getElementById('bookingModal');
            if (bookingModal) {
                bookingModal.addEventListener('shown.bs.modal', function() {
                    console.log('Booking modal shown, initializing form');
                    updateGuestFields();
                    
                    // Set up event listener for number of guests change
                    const numGuestsInput = document.getElementById('num_guests');
                    if (numGuestsInput) {
                        numGuestsInput.addEventListener('change', updateGuestFields);
                        numGuestsInput.addEventListener('input', updateGuestFields);
                    }
                });
            }
        });

        // Function to update the booking summary with night calculation and extra guest charges
        function updateBookingSummary() {
            const checkIn = document.getElementById('check_in').value;
            const checkOut = document.getElementById('check_out').value;
            const numGuests = parseInt(document.getElementById('num_guests').value) || 1;
            const nights = calculateNights(checkIn, checkOut);
            
            // Get booking items from session
            fetch('get_booking_list.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.items || data.items.length === 0) {
                        console.error('No booking items found');
                        return;
                    }
                    
                    const summaryElement = document.getElementById('bookingSummaryContent');
                    if (!summaryElement) {
                        console.error('Booking summary element not found');
                        return;
                    }
                    
                    let totalPerNight = 0;
                    let totalAmount = 0;
                    let extraGuestCharge = 0;
                    let totalCapacity = 0;
                    
                    // Calculate total capacity of all rooms
                    data.items.forEach(item => {
                        const capacity = parseInt(item.capacity) || 1;
                        const quantity = parseInt(item.quantity) || 1;
                        totalCapacity += capacity * quantity;
                    });
                    
                    // Check if number of guests exceeds total capacity
                    if (numGuests > totalCapacity) {
                        extraGuestCharge = (numGuests - totalCapacity) * 1000; // â‚±1,000 per extra guest
                    }
                    
                    const summaryHtml = data.items.map(item => {
                        const pricePerNight = parseFloat(item.price) * parseInt(item.quantity || 1);
                        totalPerNight += pricePerNight;
                        
                        // Calculate total for this room type based on nights
                        const roomTotal = nights > 0 ? pricePerNight * nights : pricePerNight;
                        totalAmount += roomTotal;
                        
                        return `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>${item.room_type} (${item.quantity || 1})</span>
                                <span>â‚±${pricePerNight.toLocaleString()} per night</span>
                            </div>
                        `;
                    }).join('');
                    
                    // Create the summary HTML with night calculation
                    let html = summaryHtml;
                    
                    if (nights > 0) {
                        html += `
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Total per night:</span>
                                <span>â‚±${totalPerNight.toLocaleString()}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Number of nights:</span>
                                <span>${nights}</span>
                            </div>
                        `;
                    }
                    
                    // Add extra guest charge if applicable
                    if (extraGuestCharge > 0) {
                        html += `
                            <div class="d-flex justify-content-between align-items-center text-danger">
                                <span>Extra guest charge (${numGuests - totalCapacity} guests exceed capacity of ${totalCapacity}):</span>
                                <span>â‚±${extraGuestCharge.toLocaleString()}</span>
                            </div>
                        `;
                        
                        // Add extra charge to total amount
                        totalAmount += extraGuestCharge;
                    }
                    
                    html += `
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total Amount:</strong>
                            <strong>â‚±${totalAmount.toLocaleString()}</strong>
                        </div>
                    `;
                    
                    summaryElement.innerHTML = html;
                    
                    // Store the total amount and extra charge for later use
                    document.getElementById('total_amount').value = totalAmount;
                    if (!document.getElementById('extra_guest_charge')) {
                        const extraChargeField = document.createElement('input');
                        extraChargeField.type = 'hidden';
                        extraChargeField.id = 'extra_guest_charge';
                        extraChargeField.name = 'extra_guest_charge';
                        document.getElementById('bookingForm').appendChild(extraChargeField);
                    }
                    document.getElementById('extra_guest_charge').value = extraGuestCharge;
                })
                .catch(error => {
                    console.error('Error updating booking summary:', error);
                });
        }

        // Make sure to update the booking summary when the number of guests changes
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listener for number of guests change
            const numGuestsInput = document.getElementById('num_guests');
            if (numGuestsInput) {
                numGuestsInput.addEventListener('change', updateBookingSummary);
                numGuestsInput.addEventListener('input', updateBookingSummary);
            }
            
            // Other existing event listeners...
        });

        // Add a hidden field to store the total amount
        document.addEventListener('DOMContentLoaded', function() {
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                // Add hidden field for total amount if it doesn't exist
                if (!document.getElementById('total_amount')) {
                    const totalAmountField = document.createElement('input');
                    totalAmountField.type = 'hidden';
                    totalAmountField.id = 'total_amount';
                    totalAmountField.name = 'total_amount';
                    bookingForm.appendChild(totalAmountField);
                }
            }
            
            // Set up event listeners for date changes
            const checkIn = document.getElementById('check_in');
            const checkOut = document.getElementById('check_out');
            
            if (checkIn && checkOut) {
                checkIn.addEventListener('change', function() {
                    // Set minimum check-out date to day after check-in
                    if (this.value) {
                        const minCheckOut = new Date(this.value);
                        minCheckOut.setDate(minCheckOut.getDate() + 1);
                        checkOut.min = minCheckOut.toISOString().split('T')[0];
                        
                        // Clear check-out if it's before new minimum
                        if (checkOut.value && new Date(checkOut.value) <= new Date(this.value)) {
                            checkOut.value = '';
                        }
                    }
                    
                    // Update booking summary if both dates are set
                    if (this.value && checkOut.value) {
                        updateBookingSummary();
                    }
                });
                
                checkOut.addEventListener('change', function() {
                    // Update booking summary if both dates are set
                    if (this.value && checkIn.value) {
                        updateBookingSummary();
                    }
                });
            }
            
            // Initialize booking form when modal is shown
            const bookingModal = document.getElementById('bookingModal');
            if (bookingModal) {
                bookingModal.addEventListener('shown.bs.modal', function() {
                    console.log('Booking modal shown, initializing form');
                    
                    // Initialize guest fields
                    updateGuestFields();
                    
                    // Set up event listener for number of guests change
                    const numGuestsInput = document.getElementById('num_guests');
                    if (numGuestsInput) {
                        numGuestsInput.addEventListener('change', updateGuestFields);
                        numGuestsInput.addEventListener('input', updateGuestFields);
                    }
                    
                    // Initialize booking summary
                    updateBookingSummary();
                });
            }
        });

        // Update the proceedToBooking function to initialize the booking summary
        function proceedToBooking() {
            // Show loading indicator
            Swal.fire({
                title: 'Checking your booking list',
                text: 'Please wait...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // First check if booking list is empty
            fetch('get_booking_list.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Booking list check response:', data); // Debug log
                    
                    // Close loading indicator
                    Swal.close();
                    
                    // Check if booking list is empty
                    if (!data.success || !data.items || data.items.length === 0) {
                        Swal.fire({
                            title: 'Empty Booking List',
                            text: 'You cannot proceed to booking with an empty list. Please add rooms to your booking list first.',
                            icon: 'warning',
                            confirmButtonColor: '#ffc107'
                        });
                        return;
                    }
                    
                    // Continue with booking process if list is not empty
                    // Close the booking list modal
                    const bookingListModal = document.getElementById('bookingListModal');
                    if (bookingListModal) {
                        const bsModal = bootstrap.Modal.getInstance(bookingListModal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    }

                    // Set minimum dates for check-in and check-out
                    const today = new Date();
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    const checkIn = document.getElementById('check_in');
                    const checkOut = document.getElementById('check_out');
                    
                    if (checkIn && checkOut) {
                        checkIn.min = today.toISOString().split('T')[0];
                        checkOut.min = tomorrow.toISOString().split('T')[0];
                        
                        // Clear any previous values
                        checkIn.value = '';
                        checkOut.value = '';
                    }

                    // Show the booking form modal
                    const bookingModal = document.getElementById('bookingModal');
                    if (bookingModal) {
                        const bsModal = new bootstrap.Modal(bookingModal);
                        bsModal.show();
                        
                        // Initialize the booking form after the modal is shown
                        setTimeout(() => {
                            updateGuestFields();
                            updateBookingSummary();
                        }, 500);
                    } else {
                        console.error('Booking modal not found');
                        Swal.fire({
                            title: 'Error',
                            text: 'Could not find booking form. Please refresh the page and try again.',
                            icon: 'error',
                            confirmButtonColor: '#ffc107'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error checking booking list:', error);
                    
                    // Close loading indicator
                    Swal.close();
                    
                    Swal.fire({
                        title: 'Error',
                        text: 'Could not check booking list. Please try again later.',
                        icon: 'error',
                        confirmButtonColor: '#ffc107'
                    });
                });
        }

        // Function to calculate discounts based on guest types
        function calculateDiscounts() {
            const guestTypes = [];
            const guestIdNumbers = {};
            let seniorOrPwdCount = 0;
            
            // Collect all guest types from the form
            const numGuests = parseInt(document.getElementById('num_guests').value) || 1;
            for (let i = 1; i <= numGuests; i++) {
                const guestTypeSelect = document.getElementById(`guest_type_${i}`);
                if (guestTypeSelect) {
                    const guestType = guestTypeSelect.value;
                    guestTypes.push(guestType);
                    
                    // Check if this guest is eligible for discount
                    if (guestType === 'Senior Citizen' || guestType === 'PWD') {
                        seniorOrPwdCount++;
                        
                        // Get ID number if it exists
                        const idNumberField = document.getElementById(`id_number_${i}`);
                        if (idNumberField) {
                            guestIdNumbers[i] = idNumberField.value;
                        }
                    }
                }
            }
            
            return {
                guestTypes,
                guestIdNumbers,
                seniorOrPwdCount,
                hasDiscount: seniorOrPwdCount > 0
            };
        }

        // Function to update guest fields with ID number fields for Senior/PWD
        function updateGuestFields() {
            const numGuests = parseInt(document.getElementById('num_guests').value) || 1;
            const guestFieldsContainer = document.getElementById('guestFieldsContainer');
            
            if (!guestFieldsContainer) {
                console.error('Guest fields container not found');
                return;
            }
            
            console.log('Updating guest fields for', numGuests, 'guests');
            
            // Always show at least one guest field
            let html = '';
            
            for (let i = 1; i <= numGuests; i++) {
                html += `
                    <div class="guest-info-card mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Guest ${i}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="guest_firstname_${i}" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="guest_firstname_${i}" name="guest_firstname_${i}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="guest_lastname_${i}" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="guest_lastname_${i}" name="guest_lastname_${i}" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="guest_type_${i}" class="form-label">Guest Type</label>
                                        <select class="form-select" id="guest_type_${i}" name="guest_type_${i}" onchange="toggleIdNumberField(${i})" required>
                                            <option value="Regular">Regular</option>
                                            <option value="Senior Citizen">Senior Citizen</option>
                                            <option value="PWD">PWD</option>
                                            <option value="Child">Child</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row id-number-row-${i}" style="display: none;">
                                    <div class="col-md-12">
                                        <label for="id_number_${i}" class="form-label">ID Number</label>
                                        <input type="text" class="form-control" id="id_number_${i}" name="id_number_${i}" placeholder="Enter ID number">
                                        <small class="text-muted">Required for Senior Citizen/PWD discount</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            guestFieldsContainer.innerHTML = html;
            console.log('Guest fields updated:', guestFieldsContainer.innerHTML.length > 0);
            
            // Set up event listeners for guest type changes
            for (let i = 1; i <= numGuests; i++) {
                const guestTypeSelect = document.getElementById(`guest_type_${i}`);
                if (guestTypeSelect) {
                    guestTypeSelect.addEventListener('change', function() {
                        toggleIdNumberField(i);
                        updateBookingSummary();
                    });
                }
            }
        }

        // Function to toggle ID number field visibility
        function toggleIdNumberField(guestIndex) {
            const guestType = document.getElementById(`guest_type_${guestIndex}`).value;
            const idNumberRow = document.querySelector(`.id-number-row-${guestIndex}`);
            
            if (guestType === 'Senior Citizen' || guestType === 'PWD') {
                idNumberRow.style.display = 'block';
            } else {
                idNumberRow.style.display = 'none';
            }
        }

        // Function to update the booking summary with night calculation, extra guest charges, and discounts
        function updateBookingSummary() {
            const checkIn = document.getElementById('check_in').value;
            const checkOut = document.getElementById('check_out').value;
            const numGuests = parseInt(document.getElementById('num_guests').value) || 1;
            const nights = calculateNights(checkIn, checkOut);
            
            // Get discount information
            const discountInfo = calculateDiscounts();
            
            // Get booking items from session
            fetch('get_booking_list.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.items || data.items.length === 0) {
                        console.error('No booking items found');
                        return;
                    }
                    
                    const summaryElement = document.getElementById('bookingSummaryContent');
                    if (!summaryElement) {
                        console.error('Booking summary element not found');
                        return;
                    }
                    
                    let totalPerNight = 0;
                    let totalAmount = 0;
                    let extraGuestCharge = 0;
                    let totalCapacity = 0;
                    let discountAmount = 0;
                    
                    // Calculate total capacity of all rooms
                    data.items.forEach(item => {
                        const capacity = parseInt(item.capacity) || 1;
                        const quantity = parseInt(item.quantity) || 1;
                        totalCapacity += capacity * quantity;
                    });
                    
                    // Check if number of guests exceeds total capacity
                    if (numGuests > totalCapacity) {
                        extraGuestCharge = (numGuests - totalCapacity) * 1000; // â‚±1,000 per extra guest
                    }
                    
                    const summaryHtml = data.items.map(item => {
                        const pricePerNight = parseFloat(item.price) * parseInt(item.quantity || 1);
                        totalPerNight += pricePerNight;
                        
                        // Calculate total for this room type based on nights
                        const roomTotal = nights > 0 ? pricePerNight * nights : pricePerNight;
                        totalAmount += roomTotal;
                        
                        return `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>${item.room_type} (${item.quantity || 1})</span>
                                <span>â‚±${pricePerNight.toLocaleString()} per night</span>
                            </div>
                        `;
                    }).join('');
                    
                    // Create the summary HTML with night calculation
                    let html = summaryHtml;
                    
                    if (nights > 0) {
                        html += `
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Total per night:</span>
                                <span>â‚±${totalPerNight.toLocaleString()}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Number of nights:</span>
                                <span>${nights}</span>
                            </div>
                        `;
                    }
                    
                    // Add extra guest charge if applicable
                    if (extraGuestCharge > 0) {
                        html += `
                            <div class="d-flex justify-content-between align-items-center text-danger">
                                <span>Extra guest charge (${numGuests - totalCapacity} guests exceed capacity of ${totalCapacity}):</span>
                                <span>â‚±${extraGuestCharge.toLocaleString()}</span>
                            </div>
                        `;
                        
                        // Add extra charge to total amount
                        totalAmount += extraGuestCharge;
                    }
                    
                    // Apply discount if applicable
                    if (discountInfo.hasDiscount && discountInfo.seniorOrPwdCount > 0) {
                        // Calculate 20% discount
                        discountAmount = totalAmount * 0.2;
                        
                        html += `
                            <div class="d-flex justify-content-between align-items-center text-success discount-animation">
                                <span>Discount (20% for Senior Citizen/PWD):</span>
                                <span>-â‚±${discountAmount.toLocaleString()}</span>
                            </div>
                        `;
                        
                        // Apply discount to total amount
                        totalAmount -= discountAmount;
                    }
                    
                    html += `
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total Amount:</strong>
                            <strong>â‚±${totalAmount.toLocaleString()}</strong>
                        </div>
                    `;
                    
                    summaryElement.innerHTML = html;
                    
                    // Add discount animation if applicable
                    if (discountInfo.hasDiscount) {
                        const discountElement = document.querySelector('.discount-animation');
                        if (discountElement) {
                            discountElement.classList.add('animate-discount');
                            setTimeout(() => {
                                discountElement.classList.remove('animate-discount');
                            }, 2000);
                        }
                    }
                    
                    // Store the total amount, extra charge, and discount for later use
                    document.getElementById('total_amount').value = totalAmount;
                    
                    if (!document.getElementById('extra_guest_charge')) {
                        const extraChargeField = document.createElement('input');
                        extraChargeField.type = 'hidden';
                        extraChargeField.id = 'extra_guest_charge';
                        extraChargeField.name = 'extra_guest_charge';
                        document.getElementById('bookingForm').appendChild(extraChargeField);
                    }
                    document.getElementById('extra_guest_charge').value = extraGuestCharge;
                    
                    if (!document.getElementById('discount_amount')) {
                        const discountField = document.createElement('input');
                        discountField.type = 'hidden';
                        discountField.id = 'discount_amount';
                        discountField.name = 'discount_amount';
                        document.getElementById('bookingForm').appendChild(discountField);
                    }
                    document.getElementById('discount_amount').value = discountAmount;
                    
                    // Store guest ID numbers
                    if (!document.getElementById('guest_id_numbers')) {
                        const guestIdNumbersField = document.createElement('input');
                        guestIdNumbersField.type = 'hidden';
                        guestIdNumbersField.id = 'guest_id_numbers';
                        guestIdNumbersField.name = 'guest_id_numbers';
                        document.getElementById('bookingForm').appendChild(guestIdNumbersField);
                    }
                    document.getElementById('guest_id_numbers').value = JSON.stringify(discountInfo.guestIdNumbers);
                })
                .catch(error => {
                    console.error('Error updating booking summary:', error);
                });
        }

        // Function to fetch payment methods from the database
        function fetchPaymentMethods() {
            fetch('get_payment_methods.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success || !data.methods || data.methods.length === 0) {
                        console.warn('No payment methods found in database, using defaults');
                        addDefaultPaymentMethods();
                        return;
                    }
                    
                    // Get the payment method select element
                    const paymentMethodSelect = document.getElementById('payment_method');
                    if (!paymentMethodSelect) {
                        console.error('Payment method select element not found');
                        return;
                    }
                    
                    // Clear existing options except the first one
                    while (paymentMethodSelect.options.length > 1) {
                        paymentMethodSelect.remove(1);
                    }
                    
                    // Add payment methods from database
                    data.methods.forEach(method => {
                        if (method.is_active === '1') {
                            const option = document.createElement('option');
                            option.value = method.name;
                            option.textContent = method.display_name;
                            option.dataset.qrCode = method.qr_code_image || '';
                            option.dataset.accountName = method.account_name || '';
                            option.dataset.accountNumber = method.account_number || '';
                            paymentMethodSelect.appendChild(option);
                        }
                    });
                    
                    // Set up event listener for payment method change
                    paymentMethodSelect.addEventListener('change', function() {
                        updatePaymentMethodDetails();
                    });
                })
                .catch(error => {
                    console.error('Error fetching payment methods:', error);
                    addDefaultPaymentMethods();
                });
        }

        // Function to update payment method details when a method is selected
        function updatePaymentMethodDetails() {
            const paymentMethodSelect = document.getElementById('payment_method');
            const selectedOption = paymentMethodSelect.options[paymentMethodSelect.selectedIndex];
            
            // Get payment details container
            const paymentDetailsContainer = document.getElementById('paymentDetailsContainer');
            if (!paymentDetailsContainer) {
                return;
            }
            
            // Clear existing content
            paymentDetailsContainer.innerHTML = '';
            
            // If no valid option is selected, return
            if (!selectedOption || selectedOption.value === '') {
                paymentDetailsContainer.style.display = 'none';
                return;
            }
            
            // Get details from the selected option
            const qrCodeImage = selectedOption.dataset.qrCode;
            const accountName = selectedOption.dataset.accountName;
            const accountNumber = selectedOption.dataset.accountNumber;
            
            // Create HTML for payment details
            let detailsHtml = '';
            
            if (accountName) {
                detailsHtml += `
                    <div class="mb-2">
                        <strong>Account Name:</strong> ${accountName}
                    </div>
                `;
            }
            
            if (accountNumber) {
                detailsHtml += `
                    <div class="mb-2">
                        <strong>Account Number:</strong> ${accountNumber}
                    </div>
                `;
            }
            
            if (qrCodeImage) {
                detailsHtml += `
                    <div class="text-center mt-3">
                        <img src="uploads/payment_qr_codes/${qrCodeImage}" alt="QR Code" class="img-fluid" style="max-width: 200px;">
                        <p class="mt-2 small text-muted">Scan this QR code to pay</p>
                    </div>
                `;
            }
            
            // Add reference number field
            detailsHtml += `
                <div class="mt-3">
                    <label for="reference_number" class="form-label">Reference Number</label>
                    <input type="text" class="form-control" id="reference_number" name="reference_number" placeholder="Enter payment reference number" required>
                    <small class="text-muted">Please enter the reference number from your payment</small>
                </div>
            `;
            
            // Add payment proof upload field
            detailsHtml += `
                <div class="mt-3">
                    <label for="payment_proof" class="form-label">Upload Payment Proof</label>
                    <input type="file" class="form-control" id="payment_proof" name="payment_proof" accept="image/*" required>
                    <small class="text-muted">Please upload a screenshot of your payment</small>
                </div>
            `;
            
            // Update the container
            paymentDetailsContainer.innerHTML = detailsHtml;
            
            // Show the container with a fade-in animation
            paymentDetailsContainer.style.display = 'block';
            paymentDetailsContainer.classList.add('fade-in');
        }

        // Initialize booking form when modal is shown
        document.addEventListener('DOMContentLoaded', function() {
            const bookingModal = document.getElementById('bookingModal');
            if (bookingModal) {
                bookingModal.addEventListener('shown.bs.modal', function() {
                    console.log('Booking modal shown, initializing form');
                    
                    // Initialize guest fields
                    updateGuestFields();
                    
                    // Fetch payment methods
                    fetchPaymentMethods();
                    
                    // Set up event listener for number of guests change
                    const numGuestsInput = document.getElementById('num_guests');
                    if (numGuestsInput) {
                        numGuestsInput.addEventListener('change', updateGuestFields);
                        numGuestsInput.addEventListener('input', updateGuestFields);
                    }
                    
                    // Initialize booking summary
                    updateBookingSummary();
                });
            }
            
            // Other existing event listeners...
        });

        // Fallback function to add default payment methods if database fetch fails
        function addDefaultPaymentMethods() {
            const paymentMethodSelect = document.getElementById('payment_method');
            if (!paymentMethodSelect) {
                return;
            }
            
            // Clear existing options except the first one
            while (paymentMethodSelect.options.length > 1) {
                paymentMethodSelect.remove(1);
            }
            
            // Add default payment methods
            const defaultMethods = [
                {
                    value: 'gcash',
                    text: 'GCash',
                    accountName: 'RAQUEL MACAPAGAL',
                    accountNumber: '+63 *** *** 4460',
                    qrCode: 'gcashpay.jpg'
                },
                {
                    value: 'maya',
                    text: 'Maya',
                    accountName: 'RAQUEL MACAPAGAL',
                    accountNumber: '09606924460',
                    qrCode: 'mayapay.jpg'
                }
            ];
            
            defaultMethods.forEach(method => {
                const option = document.createElement('option');
                option.value = method.value;
                option.textContent = method.text;
                option.dataset.accountName = method.accountName;
                option.dataset.accountNumber = method.accountNumber;
                option.dataset.qrCode = method.qrCode;
                paymentMethodSelect.appendChild(option);
            });
            
            // Set up event listener for payment method change
            paymentMethodSelect.addEventListener('change', function() {
                updatePaymentMethodDetails();
            });
        }

        // Update the fetchPaymentMethods function to use the fallback if needed
        function fetchPaymentMethods() {
            fetch('get_payment_methods.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success || !data.methods || data.methods.length === 0) {
                        console.warn('No payment methods found in database, using defaults');
                        addDefaultPaymentMethods();
                        return;
                    }
                    
                    // Get the payment method select element
                    const paymentMethodSelect = document.getElementById('payment_method');
                    if (!paymentMethodSelect) {
                        console.error('Payment method select element not found');
                        return;
                    }
                    
                    // Clear existing options except the first one
                    while (paymentMethodSelect.options.length > 1) {
                        paymentMethodSelect.remove(1);
                    }
                    
                    // Add payment methods from database
                    data.methods.forEach(method => {
                        if (method.is_active === '1') {
                            const option = document.createElement('option');
                            option.value = method.name;
                            option.textContent = method.display_name;
                            option.dataset.qrCode = method.qr_code_image || '';
                            option.dataset.accountName = method.account_name || '';
                            option.dataset.accountNumber = method.account_number || '';
                            paymentMethodSelect.appendChild(option);
                        }
                    });
                    
                    // Set up event listener for payment method change
                    paymentMethodSelect.addEventListener('change', function() {
                        updatePaymentMethodDetails();
                    });
                })
                .catch(error => {
                    console.error('Error fetching payment methods:', error);
                    addDefaultPaymentMethods();
                });
        }

        // Function to update the booking summary with night calculation, extra guest charges, and payment options
        function updateBookingSummary() {
            const checkIn = document.getElementById('check_in').value;
            const checkOut = document.getElementById('check_out').value;
            const numGuests = parseInt(document.getElementById('num_guests').value) || 1;
            const nights = calculateNights(checkIn, checkOut);
            const paymentOption = document.getElementById('payment_option').value;
            
            // Get discount information
            const discountInfo = calculateDiscounts();
            
            // Get booking items from session
            fetch('get_booking_list.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.items || data.items.length === 0) {
                        console.error('No booking items found');
                        return;
                    }
                    
                    const summaryElement = document.getElementById('bookingSummaryContent');
                    if (!summaryElement) {
                        console.error('Booking summary element not found');
                        return;
                    }
                    
                    let totalPerNight = 0;
                    let totalAmount = 0;
                    let extraGuestCharge = 0;
                    let totalCapacity = 0;
                    let discountAmount = 0;
                    let finalPaymentAmount = 0;
                    
                    // Calculate total capacity of all rooms
                    data.items.forEach(item => {
                        const capacity = parseInt(item.capacity) || 1;
                        const quantity = parseInt(item.quantity) || 1;
                        totalCapacity += capacity * quantity;
                    });
                    
                    // Check if number of guests exceeds total capacity
                    if (numGuests > totalCapacity) {
                        extraGuestCharge = (numGuests - totalCapacity) * 1000; // â‚±1,000 per extra guest
                    }
                    
                    const summaryHtml = data.items.map(item => {
                        const pricePerNight = parseFloat(item.price) * parseInt(item.quantity || 1);
                        totalPerNight += pricePerNight;
                        
                        // Calculate total for this room type based on nights
                        const roomTotal = nights > 0 ? pricePerNight * nights : pricePerNight;
                        totalAmount += roomTotal;
                        
                        return `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>${item.room_type} (${item.quantity || 1})</span>
                                <span>â‚±${pricePerNight.toLocaleString()} per night</span>
                            </div>
                        `;
                    }).join('');
                    
                    // Create the summary HTML with night calculation
                    let html = summaryHtml;
                    
                    if (nights > 0) {
                        html += `
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Total per night:</span>
                                <span>â‚±${totalPerNight.toLocaleString()}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Number of nights:</span>
                                <span>${nights}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Room Total (${nights} nights):</span>
                                <span>â‚±${totalAmount.toLocaleString()}</span>
                            </div>
                        `;
                    }
                    
                    // Add extra guest charge if applicable
                    if (extraGuestCharge > 0) {
                        html += `
                            <div class="d-flex justify-content-between align-items-center text-danger">
                                <span>Extra guest charge (${numGuests - totalCapacity} guests exceed capacity of ${totalCapacity}):</span>
                                <span>â‚±${extraGuestCharge.toLocaleString()}</span>
                            </div>
                        `;
                        
                        // Add extra charge to total amount
                        totalAmount += extraGuestCharge;
                    }
                    
                    // Apply discount if applicable
                    if (discountInfo.hasDiscount && discountInfo.seniorOrPwdCount > 0) {
                        // Calculate 20% discount
                        discountAmount = totalAmount * 0.2;
                        
                        html += `
                            <div class="d-flex justify-content-between align-items-center text-success discount-animation">
                                <span>Discount (20% for Senior Citizen/PWD):</span>
                                <span>-â‚±${discountAmount.toLocaleString()}</span>
                            </div>
                        `;
                        
                        // Apply discount to total amount
                        totalAmount -= discountAmount;
                    }
                    
                    // Calculate payment amount based on payment option
                    finalPaymentAmount = totalAmount;
                    let remainingBalance = 0;
                    
                    if (paymentOption === 'Partial Payment') {
                        // Calculate fixed down payment of â‚±1,500
                        finalPaymentAmount = 1500;
                        remainingBalance = totalAmount - finalPaymentAmount;
                        
                        html += `
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Total Amount:</strong>
                                <strong>â‚±${totalAmount.toLocaleString()}</strong>
                            </div>
                            <div class="d-flex justify-content-between align-items-center text-primary">
                                <strong>Required Down Payment:</strong>
                                <strong>â‚±${finalPaymentAmount.toLocaleString()}</strong>
                            </div>
                            <div class="d-flex justify-content-between align-items-center text-muted">
                                <span>Remaining Balance:</span>
                                <span>â‚±${remainingBalance.toLocaleString()}</span>
                            </div>
                        `;
                    } else {
                        // Full payment
                        html += `
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Total Amount (Full Payment):</strong>
                                <strong>â‚±${totalAmount.toLocaleString()}</strong>
                            </div>
                        `;
                    }
                    
                    summaryElement.innerHTML = html;
                    
                    // Add discount animation if applicable
                    if (discountInfo.hasDiscount) {
                        const discountElement = document.querySelector('.discount-animation');
                        if (discountElement) {
                            discountElement.classList.add('animate-discount');
                            setTimeout(() => {
                                discountElement.classList.remove('animate-discount');
                            }, 2000);
                        }
                    }
                    
                    // Store the total amount, payment amount, extra charge, and discount for later use
                    document.getElementById('total_amount').value = totalAmount;
                    
                    if (!document.getElementById('payment_amount')) {
                        const paymentAmountField = document.createElement('input');
                        paymentAmountField.type = 'hidden';
                        paymentAmountField.id = 'payment_amount';
                        paymentAmountField.name = 'payment_amount';
                        document.getElementById('bookingForm').appendChild(paymentAmountField);
                    }
                    document.getElementById('payment_amount').value = finalPaymentAmount;
                    
                    if (!document.getElementById('extra_guest_charge')) {
                        const extraChargeField = document.createElement('input');
                        extraChargeField.type = 'hidden';
                        extraChargeField.id = 'extra_guest_charge';
                        extraChargeField.name = 'extra_guest_charge';
                        document.getElementById('bookingForm').appendChild(extraChargeField);
                    }
                    document.getElementById('extra_guest_charge').value = extraGuestCharge;
                    
                    if (!document.getElementById('discount_amount')) {
                        const discountField = document.createElement('input');
                        discountField.type = 'hidden';
                        discountField.id = 'discount_amount';
                        discountField.name = 'discount_amount';
                        document.getElementById('bookingForm').appendChild(discountField);
                    }
                    document.getElementById('discount_amount').value = discountAmount;
                    
                    // Store guest ID numbers
                    if (!document.getElementById('guest_id_numbers')) {
                        const guestIdNumbersField = document.createElement('input');
                        guestIdNumbersField.type = 'hidden';
                        guestIdNumbersField.id = 'guest_id_numbers';
                        guestIdNumbersField.name = 'guest_id_numbers';
                        document.getElementById('bookingForm').appendChild(guestIdNumbersField);
                    }
                    document.getElementById('guest_id_numbers').value = JSON.stringify(discountInfo.guestIdNumbers);
                })
                .catch(error => {
                    console.error('Error updating booking summary:', error);
                });
        }

        // Add event listener for payment option change
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listener for payment option change
            const paymentOptionSelect = document.getElementById('payment_option');
            if (paymentOptionSelect) {
                paymentOptionSelect.addEventListener('change', updateBookingSummary);
            }
            
            // Other existing event listeners...
        });

        // Add this to your existing JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Phone number validation
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    // Remove any non-numeric characters
                    this.value = this.value.replace(/[^0-9]/g, '');
                    
                    // Limit to 11 digits
                    if (this.value.length > 11) {
                        this.value = this.value.slice(0, 11);
                    }
                    
                    // Add validation classes
                    if (this.value.length === 11) {
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                    } else {
                        this.classList.add('is-invalid');
                        this.classList.remove('is-valid');
                    }
                });
            }
        });

        // Update the form submission handler
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(this);
            
            // Show booking confirmation summary
            Swal.fire({
                title: 'Booking Summary',
                html: generateBookingSummaryHTML(formData),
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Confirm Booking',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#dc3545',
                width: '600px'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading state
                    Swal.fire({
                        title: 'Processing Booking',
                        text: 'Please wait...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Submit booking to server
                    fetch('process_booking.php', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Booking Successful!',
                                text: `Your booking reference is: ${data.booking_reference}`,
                                icon: 'success',
                                confirmButtonColor: '#ffc107'
                            }).then(() => {
                                // Clear form and redirect
                                window.location.href = 'roomss.php';
                            });
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Error',
                            text: error.message || 'Could not process booking. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#ffc107'
                        });
                    });
                }
            });
        });

        // Function to generate booking summary HTML
        function generateBookingSummaryHTML(formData) {
            const checkIn = formData.get('check_in');
            const checkOut = formData.get('check_out');
            const numGuests = formData.get('num_guests');
            const paymentMethod = formData.get('payment_method');
            const paymentOption = formData.get('payment_option');
            const totalAmount = formData.get('total_amount');
            
            let summaryHTML = `
                <div class="booking-confirmation-summary">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Guest Information</h6>
                            <p class="mb-1">Name: ${formData.get('first_name')} ${formData.get('last_name')}</p>
                            <p class="mb-1">Email: ${formData.get('email')}</p>
                            <p class="mb-1">Phone: ${formData.get('phone')}</p>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Booking Details</h6>
                            <p class="mb-1">Check-in: ${formatDate(checkIn)}</p>
                            <p class="mb-1">Check-out: ${formatDate(checkOut)}</p>
                            <p class="mb-1">Number of Guests: ${numGuests}</p>
                            <p class="mb-1">Number of Nights: ${calculateNights(checkIn, checkOut)}</p>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Payment Details</h6>
                            <p class="mb-1">Payment Method: ${paymentMethod}</p>
                            <p class="mb-1">Payment Option: ${paymentOption}</p>
                            <p class="mb-1">Total Amount: â‚±${parseFloat(totalAmount).toLocaleString()}</p>
                            ${generateDiscountHTML(formData)}
                        </div>
                    </div>
                </div>
            `;
            
            return summaryHTML;
        }

        // Helper function to format date
        function formatDate(dateString) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        // Helper function to generate discount HTML
        function generateDiscountHTML(formData) {
            let discountHTML = '';
            const numGuests = parseInt(formData.get('num_guests'));
            
            for (let i = 1; i <= numGuests; i++) {
                const guestType = formData.get(`guest_type_${i}`);
                if (guestType === 'Senior Citizen' || guestType === 'PWD') {
                    const discountAmount = parseFloat(formData.get('total_amount')) * 0.2; // 20% discount
                    discountHTML += `
                        <div class="text-success">
                            <p class="mb-1">Discount Type: ${guestType}</p>
                            <p class="mb-1">Discount Amount: â‚±${discountAmount.toLocaleString()}</p>
                            <p class="mb-1">Final Amount: â‚±${(parseFloat(formData.get('total_amount')) - discountAmount).toLocaleString()}</p>
                        </div>
                    `;
                    break; // Only show discount for first eligible guest
                }
            }
            
            return discountHTML;
        }

        // Helper function to calculate nights
        function calculateNights(checkIn, checkOut) {
            const start = new Date(checkIn);
            const end = new Date(checkOut);
            const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            return nights;
        }

        // Function to show booking summary confirmation
        function showBookingSummaryConfirmation() {
            const form = document.getElementById('bookingForm');
            const formData = new FormData(form);
            
            // Get booking details
            const checkIn = new Date(formData.get('check_in')).toLocaleDateString();
            const checkOut = new Date(formData.get('check_out')).toLocaleDateString();
            const numGuests = formData.get('num_guests');
            const arrivalTime = formData.get('arrival_time');
            const paymentMethod = formData.get('payment_method');
            const paymentOption = formData.get('payment_option');
            
            // Calculate number of nights
            const nights = Math.ceil((new Date(formData.get('check_out')) - new Date(formData.get('check_in'))) / (1000 * 60 * 60 * 24));
            
            // Get the current booking summary content
            const summaryContent = document.getElementById('bookingSummaryContent').innerHTML;
            
            Swal.fire({
                title: 'Confirm Your Booking',
                html: `
                    <div class="booking-summary-modal">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Booking Details</h6>
                                <p class="mb-1"><strong>Check-in:</strong> ${checkIn}</p>
                                <p class="mb-1"><strong>Check-out:</strong> ${checkOut}</p>
                                <p class="mb-1"><strong>Number of Nights:</strong> ${nights}</p>
                                <p class="mb-1"><strong>Number of Guests:</strong> ${numGuests}</p>
                                <p class="mb-1"><strong>Arrival Time:</strong> ${arrivalTime}</p>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Room & Payment Details</h6>
                                ${summaryContent}
                                <p class="mb-2"><strong>Payment Method:</strong> ${paymentMethod}</p>
                                <p class="mb-2"><strong>Payment Option:</strong> ${paymentOption}</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i> Please review all details carefully before confirming your booking.
                        </div>

                        <div class="policy-section mt-3">
                            <div class="policy-content mb-3" style="max-height: 200px; overflow-y: auto; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background-color: #f8f9fa;">
                                <h6 class="text-center mb-3">CASA ESTELA BOUTIQUE HOTEL & CAFÃ‰<br>HOUSE RULES AND REGULATION</h6>
                                <p class="small mb-3">Our warmest welcome to Casa Estela Boutique Hotel & CafÃ©!</p>
                                <p class="small mb-2">To ensure your comfortable and pleasant stay, may we request for your cooperation in following our House Rules and Regulations:</p>
                                <ul class="small policy-list ps-3">
                                    <li>A hotel day starts at any time after 1:00 pm during the day of arrival and ends at 11:00 A.M. of the following day. Late check-outs shall be charged at Php 200.00 per hour for a maximum of two hours extension only. Exceeding beyond 2:00 p.m. will be considered as a one-night stay and will be charged automatically.</li>
                                    <li>Breakfast will be served between 7:00 a.m. and 8:00 a.m. only.</li>
                                    <li>A refundable deposit of Php 500.00 is required upon issuance of the room key and card.</li>
                                    <li>Request for an extra pillow, duvet, bath towel or bath mat will incur an additional charge.</li>
                                    <li>Kindly deposit your room key and card at the front desk whenever you leave the hotel premises.</li>
                                    <li>Kindly turn-off lights, water supply fixtures and electrical appliances before leaving the room and when not in use.</li>
                                    <li>Smoking inside the room is strictly prohibited. If found, a penalty of P500 will be imposed.</li>
                                    <li>The management will not be held liable in any case of loss in personal property. A security box is available at the front desk where you can deposit your valuables. However, the management has the right to refuse to store money and other belongings if: they pose a threat to safety, their value exceeds the standard of the hotel or if they take up too much space.</li>
                                    <li>Damage to any hotel's equipment, fixtures or property shall result to corresponding financial charges.</li>
                                    <li>Left and unclaimed items will be kept for a period of 1 month from your departure date, unless otherwise instructed.</li>
                                    <li>PWD and Senior Citizen discounts are applicable to cash payments only.</li>
                                </ul>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="policyCheckbox" required>
                                <label class="form-check-label" for="policyCheckbox">I have read and agree to the house rules and regulations</label>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Confirm & Pay',
                cancelButtonText: 'Make Changes',
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                width: '600px',
                preConfirm: () => {
                    if (!document.getElementById('policyCheckbox').checked) {
                        Swal.showValidationMessage('Please read and agree to the house rules and regulations');
                        return false;
                    }
                    return true;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading state
                    Swal.fire({
                        title: 'Processing Your Booking',
                        text: 'Please wait while we confirm your reservation...',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Submit the booking form
                    fetch('process_booking.php', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Booking Successful!',
                                html: `
                                    <div class="text-center">
                                        <div class="mb-3">
                                            <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                                        </div>
                                        <h5 class="mb-3">Thank you for your booking!</h5>
                                        <p class="mb-2">Your booking reference number is:</p>
                                        <h4 class="text-primary mb-3">${data.booking_reference}</h4>
                                        <p class="text-muted small">A confirmation email has been sent to your email address.</p>
                                    </div>
                                `,
                                icon: 'success',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#ffc107'
                            }).then(() => {
                                // Redirect to the rooms page or booking confirmation page
                                window.location.href = 'roomss.php';
                            });
                        } else {
                            throw new Error(data.message || 'Failed to process booking');
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Booking Failed',
                            text: error.message || 'There was an error processing your booking. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#ffc107'
                        });
                    });
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    // Reopen the booking modal if user wants to make changes
                    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
                    bookingModal.show();
                }
            });
        }

        // Booking list management
        function addToList(roomId, roomName, roomPrice) {
            const roomData = {
                id: roomId,
                name: roomName,
                price: roomPrice,
                dateAdded: new Date().toISOString()
            };
            
            let bookingList = JSON.parse(localStorage.getItem('bookingList')) || [];
            
            // Check if room is already in list
            if (!bookingList.some(item => item.id === roomId)) {
                bookingList.push(roomData);
                localStorage.setItem('bookingList', JSON.stringify(bookingList));
                
                // Update badge
                const badge = document.getElementById('mobileBedBadge');
                if (badge) {
                    badge.textContent = bookingList.length;
                    badge.style.display = 'flex';
                }
                
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Added to list',
                    text: 'Room has been added to your booking list',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else {
                // Show already in list message
                Swal.fire({
                    icon: 'info',
                    title: 'Already in list',
                    text: 'This room is already in your booking list',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            }
        }

        function removeFromList(roomId) {
            let bookingList = JSON.parse(localStorage.getItem('bookingList')) || [];
            bookingList = bookingList.filter(item => item.id !== roomId);
            localStorage.setItem('bookingList', JSON.stringify(bookingList));
            
            // Update badge
            const badge = document.getElementById('mobileBedBadge');
            if (badge) {
                if (bookingList.length > 0) {
                    badge.textContent = bookingList.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Removed from list',
                text: 'Room has been removed from your booking list',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000
            });
        }

        // Initialize badge count when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const bookingList = JSON.parse(localStorage.getItem('bookingList')) || [];
            const badge = document.getElementById('mobileBedBadge');
            if (badge) {
                if (bookingList.length > 0) {
                    badge.textContent = bookingList.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        });

        // Add this helper function for safe HTML escaping
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Add this helper function to handle image paths
        function getImagePath(imagePath) {
            if (!imagePath) {
                return '../../../Admin/uploads/rooms/default.jpg';
            }
            
            if (imagePath.includes('uploads/')) {
                return '../../../Admin/' + imagePath;
            }
            
            return '../../../Admin/uploads/rooms/' + imagePath.split('/').pop();
        }
    </script>
</body>
</html>
                                                                                                                                                